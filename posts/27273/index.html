<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><link href="https://fastly.jsdelivr.net/npm/hexo-tag-common@0.1.0/css/index.css" rel="stylesheet"><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="AWEI"><meta name="keywords" content="AWEI,AWEI的技术小屋"><meta name="description" content="NoSQL 数据库NoSQL 数据库概述NoSQL (Not Only SQL)，即 “不仅仅是 SQL”，泛指非关系型的数据库。 NoSQL 不依赖业务逻辑方式存储，而以简单的 key-value 模式存储。因此大大的增加了数据库的扩展能力。  不遵循 SQL 标准 不支持 ACID  远超于 SQL 的性能  NoSQL 适用场景 对数据高并发的读写 海量数据的读写 对数据高可扩展性的  No"><meta property="og:type" content="article"><meta property="og:title" content="Redis"><meta property="og:url" content="https://www.inencoding.com/posts/27273/index.html"><meta property="og:site_name" content="In-Encoding"><meta property="og:description" content="NoSQL 数据库NoSQL 数据库概述NoSQL (Not Only SQL)，即 “不仅仅是 SQL”，泛指非关系型的数据库。 NoSQL 不依赖业务逻辑方式存储，而以简单的 key-value 模式存储。因此大大的增加了数据库的扩展能力。  不遵循 SQL 标准 不支持 ACID  远超于 SQL 的性能  NoSQL 适用场景 对数据高并发的读写 海量数据的读写 对数据高可扩展性的  No"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.inencoding.com/img/%E6%96%87%E7%AB%A0/redis.jpg"><meta property="article:published_time" content="2022-04-04T15:53:11.000Z"><meta property="article:modified_time" content="2022-12-08T15:28:22.383Z"><meta property="article:author" content="AWEI"><meta property="article:tag" content="数据库"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://www.inencoding.com/img/%E6%96%87%E7%AB%A0/redis.jpg"><meta name="referrer" content="no-referrer-when-downgrade"><title>Redis - In-Encoding</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/fluid-extention.css"><script id="fluid-configs">var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"www.inencoding.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"https://cdn.jsdelivr.net/gh/AWeiIsCoding/AWeiIsCoding.github.io/local-search.xml"});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><style>.spoiler{display:inline-flex}p.spoiler{display:flex}.spoiler a{pointer-events:none}.spoiler-blur,.spoiler-blur>*{transition:text-shadow .5s ease}.spoiler .spoiler-blur,.spoiler .spoiler-blur>*{color:transparent;background-color:rgba(0,0,0,0);text-shadow:0 0 10px grey;cursor:pointer}.spoiler .spoiler-blur:hover,.spoiler .spoiler-blur:hover>*{text-shadow:0 0 5px grey}.spoiler-box,.spoiler-box>*{transition:color .5s ease,background-color .5s ease}.spoiler .spoiler-box,.spoiler .spoiler-box>*{color:#000;background-color:#000;text-shadow:none}</style><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="In-Encoding" type="application/atom+xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>InEncoding</strong></a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/background.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Redis"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> AWEI</span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-04-04 23:53" pubdate>2022年4月4日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 50k 字</span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 419 分钟</span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="学习笔记" id="heading-078425eaf316a180b0989442e53f920b" role="tab" data-toggle="collapse" href="#collapse-078425eaf316a180b0989442e53f920b" aria-expanded="true">学习笔记 <span class="list-group-count">(23)</span><i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-078425eaf316a180b0989442e53f920b" role="tabpanel" aria-labelledby="heading-078425eaf316a180b0989442e53f920b"><div class="category-post-list"><a href="/posts/53027/" title="Ajax 和 Json" class="list-group-item list-group-item-action"><span class="category-post">Ajax 和 Json</span></a> <a href="/posts/40991/" title="Docker" class="list-group-item list-group-item-action"><span class="category-post">Docker</span></a> <a href="/posts/14402/" title="Docker 常用环境搭建" class="list-group-item list-group-item-action"><span class="category-post">Docker 常用环境搭建</span></a> <a href="/posts/22111/" title="JQuery 学习笔记" class="list-group-item list-group-item-action"><span class="category-post">JQuery 学习笔记</span></a> <a href="/posts/43258/" title="Java 多线程学习笔记" class="list-group-item list-group-item-action"><span class="category-post">Java 多线程学习笔记</span></a> <a href="/posts/12475/" title="Java 注解与反射" class="list-group-item list-group-item-action"><span class="category-post">Java 注解与反射</span></a> <a href="/posts/15254/" title="Java 网络编程学习笔记" class="list-group-item list-group-item-action"><span class="category-post">Java 网络编程学习笔记</span></a> <a href="/posts/16781/" title="JavaWeb 学习笔记" class="list-group-item list-group-item-action"><span class="category-post">JavaWeb 学习笔记</span></a> <a href="/posts/33152/" title="MyBatis-Plus" class="list-group-item list-group-item-action"><span class="category-post">MyBatis-Plus</span></a> <a href="/posts/39805/" title="MySQL 学习笔记" class="list-group-item list-group-item-action"><span class="category-post">MySQL 学习笔记</span></a> <a href="/posts/15608/" title="Mybatis" class="list-group-item list-group-item-action"><span class="category-post">Mybatis</span></a> <a href="/posts/27273/" title="Redis" class="list-group-item list-group-item-action active"><span class="category-post">Redis</span></a> <a href="/posts/18155/" title="Spring" class="list-group-item list-group-item-action"><span class="category-post">Spring</span></a> <a href="/posts/46897/" title="Spring MVC" class="list-group-item list-group-item-action"><span class="category-post">Spring MVC</span></a> <a href="/posts/33757/" title="SpringBoot" class="list-group-item list-group-item-action"><span class="category-post">SpringBoot</span></a> <a href="/posts/42622/" title="SpringCloud" class="list-group-item list-group-item-action"><span class="category-post">SpringCloud</span></a> <a href="/posts/43782/" title="Vue" class="list-group-item list-group-item-action"><span class="category-post">Vue</span></a> <a href="/posts/43167/" title="git" class="list-group-item list-group-item-action"><span class="category-post">git</span></a> <a href="/posts/62461/" title="python 爬虫" class="list-group-item list-group-item-action"><span class="category-post">python 爬虫</span></a> <a href="/posts/13607/" title="基于 Centos6.5 的 Httpd 安装" class="list-group-item list-group-item-action"><span class="category-post">基于 Centos6.5 的 Httpd 安装</span></a> <a href="/posts/6262/" title="基于 Centos6.8 的 Hadoop 分布式集群安装" class="list-group-item list-group-item-action"><span class="category-post">基于 Centos6.8 的 Hadoop 分布式集群安装</span></a> <a href="/posts/59309/" title="基于 Centos7 的 Zookeeper 安装" class="list-group-item list-group-item-action"><span class="category-post">基于 Centos7 的 Zookeeper 安装</span></a> <a href="/posts/13858/" title="软件工程随笔" class="list-group-item list-group-item-action"><span class="category-post">软件工程随笔</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Redis</h1><p class="note note-warning">本文最后更新于：2022年12月8日 晚上</p><div class="markdown-body"><h1 id="NoSQL数据库"><a href="#NoSQL数据库" class="headerlink" title="NoSQL数据库"></a>NoSQL 数据库</h1><h2 id="NoSQL-数据库概述"><a href="#NoSQL-数据库概述" class="headerlink" title="NoSQL 数据库概述"></a>NoSQL 数据库概述</h2><p>NoSQL (Not Only SQL)，即 <strong>“不仅仅是 SQL”</strong>，泛指非关系型的数据库。</p><p>NoSQL 不依赖业务逻辑方式存储，而以简单的 key-value 模式存储。因此大大的增加了数据库的扩展能力。</p><ul><li>不遵循 SQL 标准</li><li>不支持 ACID</li><li>远超于 SQL 的性能</li></ul><h2 id="NoSQL-适用场景"><a href="#NoSQL-适用场景" class="headerlink" title="NoSQL 适用场景"></a>NoSQL 适用场景</h2><ul><li>对数据高并发的读写</li><li>海量数据的读写</li><li>对数据高可扩展性的</li></ul><h2 id="NoSQL-不适用场景"><a href="#NoSQL-不适用场景" class="headerlink" title="NoSQL 不适用场景"></a>NoSQL 不适用场景</h2><ul><li>需要事务支持</li><li>基于 sql 的结构化查询存储，处理复杂的关系，需要<strong>即席</strong>查询。</li><li><strong>用不着 sql 的和用了 sql 也不行的情况，请考虑用 NoSQL</strong></li></ul><h2 id="常见的-NoSQL-数据库"><a href="#常见的-NoSQL-数据库" class="headerlink" title="常见的 NoSQL 数据库"></a>常见的 NoSQL 数据库</h2><ul><li>Memcache<ul><li>很早就已经出现的 NoSql 数据库</li><li>数据都在内存中，一般<strong>不持久化</strong></li><li>支持简单的 key-value 模式，<strong>支持类型单一</strong></li><li>一般是作为<strong>缓存数据库</strong>辅助持久化的数据库</li></ul></li><li>Redis<ul><li>几乎覆盖了 Memcached 的绝大部分功能、</li><li>数据都在内存中，<strong>支持持久化</strong>，主要用作备份恢复</li><li>除了支持简单的 key-value 模式，还<strong>支持多种数据结构的存储</strong>，比如 list、set、hash、zset 等。</li><li>一般是作为<strong>缓存数据库</strong>辅助持久化的数据库</li></ul></li><li>MongoDB<ul><li>高性能、开源、模式自由 (schema free) 的<strong>文档型数据库</strong></li><li>数据都在内存中， 如果内存不足，把不常用的数据保存到硬盘</li><li>虽然是 key-value 模式，但是对 value（尤其是 <strong>json</strong>）提供了丰富的查询功能</li><li>支持二进制数据及大型对象</li><li>可以根据数据的特点<strong>替代 RDBMS</strong> ，成为独立的数据库。或者配合 RDBMS，存储特定的数据。</li></ul></li></ul><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="Redis-概述"><a href="#Redis-概述" class="headerlink" title="Redis 概述"></a>Redis 概述</h2><ol><li>Redis 是一个<strong>开源</strong>的 <strong>key-value</strong> 存储系统。</li><li>和 Memcached 类似，它支持存储的 value 类型相对更多，包括 <strong>string</strong> (字符串)、<strong>list</strong> (链表)、<strong>set</strong> (集合)、<strong>zset</strong> (sorted set – 有序集合) 和 <strong>hash</strong>（哈希类型）。</li><li>这些数据类型都支持 push/pop、add/remove 及取交集并集和差集及更丰富的操作，而且这些操作都是<strong>原子性</strong>的。</li><li>在此基础上，Redis 支持各种不同方式的<strong>排序</strong>。</li><li>与 memcached 一样，为了保证效率，数据都是<strong>缓存在内存</strong>中。</li><li>区别的是 Redis 会<strong>周期性</strong>的把<strong>更新的数据写入磁盘</strong>或者把修改操作写入追加的记录文件。</li><li>并且在此基础上实现了 <strong>master-slave (主从)</strong> 同步。</li></ol><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul><li><p>配合关系型数据库做高速缓存</p><ul><li>高频次，热门访问的数据，降低数据库 IO</li><li>分布式架构，做 session 共享</li></ul></li><li><p>多样的数据结构存储持久化数据</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220405004046.png" srcset="/img/loading.gif" lazyload alt="image-20220405004046157"></p></li></ul><h2 id="Redis安装步骤"><a href="#Redis安装步骤" class="headerlink" title="Redis安装步骤"></a>Redis 安装步骤</h2><ol><li><p>进入 <a target="_blank" rel="noopener" href="https://github.com/redis/redis/releases/tag/6.2.6">Redis 下载地址</a>，下载 6.2.6 版本 Redis。</p></li><li><p>使用 ftp 软件连接到 Linux 操作系统，将 Redis 压缩文件上传到 /opt 目录下</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220405231220.png" srcset="/img/loading.gif" lazyload alt="image-20220405231220319"></p></li><li><p>使用 ssh 工具连接到你的 Linux 系统，进入 <code>/opt</code> 目录</p></li><li><p>下载安装最新版的 gcc 编译器（下载过程中出现依赖更新提示统统输入 <strong>y</strong> 即可）</p><ul><li><p>使用 yum 命令进行安装，命令为：<code>yum install -y gcc</code></p></li><li><p>最后查看版本得知是否安装成功，命令为：<code>gcc --version</code></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220405231624.png" srcset="/img/loading.gif" lazyload alt="image-20220405231624495"></p></li></ul></li><li><p>解压 redis 压缩文件</p><p>命令为：<code>tar -zxvf redis-6.2.6.tar.gz</code></p></li><li><p>进入解压好的 redis 文件，执行 make 命令以及 make install 命令进行编译安装</p><p>命令为：<code>cd redis-6.2.6</code> ，然后使用 <code>make &amp;&amp; make install</code>。</p></li><li><p>在 /usr/local/bin (<strong>Redis 安装目录</strong>) 中使用 <code>ls</code> , 出现以下即为安装成功</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220405232430.png" srcset="/img/loading.gif" lazyload alt="image-20220405232430778"></p></li><li><p>在这步如果出现报错，首先检查有无安装最新版 gcc，然后运行 <code>make distclean</code>，最后重新运行 <code>make &amp;&amp; make install</code></p></li></ol><h2 id="Redis安装目录"><a href="#Redis安装目录" class="headerlink" title="Redis安装目录"></a>Redis 安装目录</h2><p>Redis 数据库成功安装后，<strong>默认安装目录为：/usr/local/bin</strong></p><p>查看默认安装目录：</p><blockquote><p>redis-benchmark：性能测试工具，可以在自己本子运行，看看自己本子性能如何<br>redis-check-aof：修复有问题的 AOF 文件，rdb 和 aof 后面讲<br>redis-check-dump：修复有问题的 dump.rdb 文件<br>redis-sentinel：Redis 集群使用<br><strong>redis-server</strong>：Redis 服务器启动命令<br><strong>redis-cli</strong>：客户端，操作入口</p></blockquote><h2 id="启动Redis"><a href="#启动Redis" class="headerlink" title="启动Redis"></a>启动 Redis</h2><h3 id="前台启动（不推荐）"><a href="#前台启动（不推荐）" class="headerlink" title="前台启动（不推荐）"></a>前台启动（不推荐）</h3><p>前台启动，命令行窗口不能关闭，否则服务器停止！</p><p>在 <strong>Redis 安装目录</strong>下，启动命令：<code>redis-server</code></p><h3 id="后台启动"><a href="#后台启动" class="headerlink" title="后台启动"></a>后台启动</h3><ol><li><p>将 redis.conf 复制到其他目录下：<code>cp /opt/redis-6.2.6/redis.conf /etc/redis.conf</code></p></li><li><p>修改 redis.conf (257 行) 文件将里面的 <code>daemonize no</code> 改成 <code>yes</code>，让服务在后台启动</p><p>命令为：<code>vim /etc/redis.conf</code></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220405233453.png" srcset="/img/loading.gif" lazyload alt="image-20220405233453761"></p></li><li><p>启动 Redis：首先进入 <code>cd /usr/local/bin</code> 目录，然后执行命令：<code>redis-server /etc/redis.conf</code></p></li><li><p>查看是否在运行：<code>ps -ef |grep redis</code></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220406010113.png" srcset="/img/loading.gif" lazyload alt="image-20220406010113320"></p></li><li><p>用客户端访问：<code>redis-cli</code></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220406010225.png" srcset="/img/loading.gif" lazyload alt="image-20220406010225853"></p></li><li><p>测试验证： <code>ping</code></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220406010251.png" srcset="/img/loading.gif" lazyload alt="image-20220406010251651"></p></li><li><p>退出客户端：<code>exit</code></p></li><li><p>关闭 redis 后台：</p><p>关闭后台 <code>redis-cli shutdown</code> 或者是关闭进程号 <code>kill -9 进程号</code></p></li></ol><h2 id="Redis相关知识"><a href="#Redis相关知识" class="headerlink" title="Redis相关知识"></a>Redis 相关知识</h2><ul><li><p>默认 16 个数据库，类似数组下标从 0 开始，初始<strong>默认使用 0 号库</strong></p></li><li><p>使用命令 <code>select &lt;dbid&gt;</code> 来切换数据库。如: <code>select 8</code></p></li><li><p>统一密码管理，所有库同样密码。</p></li><li><p><code>dbsize</code> 查看当前数据库的 key 的数量</p></li><li><p><code>flushdb</code><strong>清空当前库</strong></p></li><li><p><code>flushall</code><strong>通杀全部库</strong></p></li><li><p><strong>Redis 是单线程 + 多路 IO 复用技术</strong>，与 Memcache 三点不同：支持多数据类型，支持持久化，单线程 + 多路 IO 复用</p><blockquote><p>多路复用是指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用 select 和 poll 函数，传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）</p></blockquote></li><li><p>与 Memcache 三点不同: <strong>支持多数据类型，支持持久化，单线程 + 多路 IO 复用</strong></p></li></ul><h1 id="Redis常用五大数据类型"><a href="#Redis常用五大数据类型" class="headerlink" title="Redis常用五大数据类型"></a>Redis 常用五大数据类型</h1><h2 id="键（key）"><a href="#键（key）" class="headerlink" title="键（key）"></a>键（key）</h2><ul><li>查看当前库所有 <code>&lt;key&gt;</code>（匹配：keys *1）：<code>key *</code></li><li>判断某个 <code>&lt;key&gt;</code> 是否存在：<code>exists &lt;key&gt;</code></li><li>查看你的 <code>&lt;key&gt;</code> 是什么类型：<code>type &lt;key&gt;</code></li><li>删除指定的 <code>&lt;key&gt;</code> 数据：<code>del &lt;key&gt;</code></li><li>从当前数据库中随机返回一个 <code>&lt;key&gt;</code>：<code>randomkey</code></li><li>修改 key 的名称：<code>rename &lt;key&gt; &lt;newkey&gt;</code></li><li>仅当 <code>&lt;newkey&gt;</code> 不存在时，将 <code>&lt;key&gt;</code> 改名为 <code>&lt;newkey&gt;</code>：<code>renamenx &lt;key&gt; &lt;newkey&gt;</code></li><li>迭代数据库中的数据库键：<code>scan cursor [match pattern] [count counts]</code></li><li>根据 <code>&lt;value&gt;</code> 选择非阻塞删除 (<strong>仅将 keys 从 keyspace 元数据中删除，真正的删除会在后续异步操作</strong>)：<code>unlink &lt;key&gt;</code></li><li>为给定的 <code>&lt;key&gt;</code> 设置过期时间，例如 10 秒：<code>expire &lt;key&gt; 10</code></li><li>用于为 key 设置过期时间。 不同在于 expireat 命令接受的时间参数是 UNIX 时间戳：<code>expireat &lt;key&gt; timestamp</code></li><li>设置 key 的过期时间以毫秒计：<code>pexpire &lt;key&gt; milliseconds</code></li><li>设置 key 过期时间的时间戳 (unix timestamp) 以毫秒计：<code>pexpireat &lt;key&gt; milliseconds-timestamp</code></li><li>查看还有多少秒过期，-1 表示永不过期，-2 表示已过期：<code>ttl &lt;key&gt;</code></li><li>以<strong>毫秒</strong>查看还有多少秒过期：<code>pttl &lt;key&gt;</code></li><li>序列化给定 <code>&lt;key&gt;</code> ，并返回被序列化的值：<code>dump &lt;key&gt;</code></li><li>查找所有符合给定模式 (pattern) 的 key ：<code>keys &lt;pattern&gt;</code></li><li>将当前数据库的 key 移动到给定的数据库 db 当中：<code>move &lt;key&gt; &lt;db&gt;</code></li><li>移除 <code>&lt;key&gt;</code> 的过期时间，<code>&lt;key&gt;</code> 将持久保持：<code>persist &lt;key&gt;</code></li><li><code>select</code> 命令：切换数据库<br><code>dbsize</code> 命令：查看当前数据库的 key 的数量<br><code>flushdb</code> 命令：清空当前库<br><code>flushall</code> 命令：通杀全部库</li></ul><h2 id="字符串（String）"><a href="#字符串（String）" class="headerlink" title="字符串（String）"></a>字符串（String）</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>String 是 Redis 最基本的类型，你可以理解成与 Memcached 一模一样的类型，一个 key 对应一个 value。</p><p>String 类型是<strong>二进制安全的</strong>。意味着 Redis 的 string 可以包含任何数据。比如 jpg 图片或者序列化的对象。</p><p>String 类型是 Redis 最基本的数据类型，一个 Redis 中字符串 value 最多可以是 <strong>512M</strong></p><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ul><li>添加键值对：<code>set &lt;key&gt; &lt;value&gt;</code></li><li>查询对应键值：<code>get &lt;key&gt;</code></li><li>将给定的 <code>&lt;value&gt;</code> 追加到原值的末尾：<code>append &lt;key&gt; &lt;value&gt;</code></li><li>获得值的长度：<code>strlen &lt;key&gt;</code></li><li>只有在 <code>&lt;key&gt;</code> 不存在时设置 key 的值：<code>setnx &lt;key&gt; &lt;value&gt;</code></li><li>将 <code>&lt;key&gt;</code> 中储存的数字值增 1，<strong>只能对数字值操作</strong>，如果为空，新增值为 1：<code>incr &lt;key&gt;</code></li><li>将 <code>&lt;key&gt;</code> 中储存的数字值减 1，<strong>只能对数字值操作</strong>，如果为空，新增值为 -1：<code>decr &lt;key&gt;</code></li><li>将 <code>&lt;key&gt;</code> 中储存的数字值增减，自定义步长：<code>incrby / decrby &lt;key&gt; &lt;数字值&gt;</code></li><li>将 <code>&lt;key&gt;</code> 所储存的值加上给定的浮点增量值：<code>incrbyfloat &lt;key&gt; &lt;数字值&gt;</code></li><li>同时设置一个或多个 key-value 对：<code>mset &lt;key1&gt; &lt;value1&gt; &lt;key2&gt; &lt;value2&gt;...</code></li><li>同时获取一个或多个 <code>&lt;value&gt;</code>：<code>mget &lt;key1&gt; &lt;key2&gt; &lt;key3&gt;...</code></li><li>同时设置一个或多个 key-value 对，当且仅当所有给定 <code>&lt;key&gt;</code> 都不存在 (<strong>原子性，有一个失败则都失败</strong>)：<code>msetnx &lt;key1&gt; &lt;value1&gt; &lt;key2&gt; &lt;value2&gt;...</code></li><li>获得值的范围，类似 java 中的 substring，前包，后包：<code>getrange &lt;key&gt; &lt;起始位置&gt; &lt;结束位置&gt;</code></li><li>用 <code>&lt;value&gt;</code> 覆写 <code>&lt;key&gt;</code> 所储存的字符串值，从起始位置开始 (索引从 0 开始)：<code>setrange &lt;key&gt; &lt;起始位置&gt; &lt;value&gt;</code></li><li>设置键值的同时，设置过期时间，单位秒：<code>setex &lt;key&gt; &lt;过期时间&gt; &lt;value&gt;</code></li><li>以毫秒为单位设置 key 的生存时间：<code>psetex &lt;key&gt; &lt;过期时间&gt; &lt;value&gt;</code></li><li>以新换旧，设置了新值同时获得旧值：<code>getset &lt;key&gt; &lt;value&gt;</code></li><li>对 <code>&lt;key&gt;</code> 所储存的字符串值，设置或清除指定偏移量上的位 (bit)：<code>setbit &lt;key&gt; &lt;offset&gt; &lt;value&gt;</code></li><li>对 <code>&lt;key&gt;</code> 所储存的字符串值，获取指定偏移量上的位 (bit)：<code>getbit &lt;key&gt; &lt;offset&gt;</code></li></ul><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p>String 的数据结构为简单动态字符串 (Simple Dynamic String, 缩写 SDS)。是可以修改的字符串，内部结构实现上类似于 Java 的 <strong>ArrayList</strong>，采用预分配冗余空间的方式来减少内存的频繁分配。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220407014949.png" srcset="/img/loading.gif" lazyload alt="image-20220407014949648"></p><p>如图中所示，内部为当前字符串实际分配的空间 capacity 一般要高于实际字符串长度 len。<strong>当字符串长度小于 1M 时，扩容都是加倍现有的空间，如果超过 1M，扩容时一次只会多扩 1M 的空间。需要注意的是字符串最大长度为 512M。</strong></p><h2 id="列表（List）"><a href="#列表（List）" class="headerlink" title="列表（List）"></a>列表（List）</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p><strong>单键多值</strong></p><p>Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。</p><p>它的底层实际是个<strong>双向链表</strong>，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220407015208.png" srcset="/img/loading.gif" lazyload alt="image-20220407015208895"></p><h3 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h3><ul><li><p>移出并获取列表的第一个元素， 如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止：<code>BLPOP &lt;key1&gt; &lt;key2&gt;... &lt;过期时间&gt;</code></p></li><li><p>移出并获取列表的最后一个元素， 如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止：<code>BRPOP &lt;key1&gt; &lt;key2&gt;... &lt;过期时间&gt;</code></p></li><li><p>从 <code>&lt;key1&gt;</code> 中弹出一个值，将弹出的元素插入到 <code>&lt;key2&gt;</code> 中并返回它； 如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止：<code>BRPOPLPUSH &lt;key1&gt; &lt;key2&gt; &lt;过期时间&gt;</code></p></li><li><p>从左边 / 右边插入一个或多个值：<code>lpush/rpush &lt;key&gt; &lt;value1&gt; &lt;value2&gt; &lt;value3&gt; ....</code></p></li><li><p>将一个值插入到已存在的列表头部 / 尾部，返回列表长度：<code>lpushx/rpushx &lt;key&gt; &lt;value&gt;</code></p></li><li><p>保留指定区间内的元素，不在指定区间之内的元素都将被删除：<code>ltrim &lt;key&gt; &lt;start&gt; &lt;stop&gt;</code></p></li><li><p>从左边 / 右边吐出一个值 (<strong>值在键在，值光键亡</strong>)：<code>lpop/rpop &lt;key&gt;</code></p></li><li><p>从 <code>&lt;key1&gt;</code> 列表右边吐出一个值，插到 <code>&lt;key2&gt;</code> 列表左边：<code>rpoplpush &lt;key1&gt; &lt;key2&gt;</code></p></li><li><p>按照索引下标获得元素 (从左到右)：<code>lrange &lt;key&gt; &lt;start&gt; &lt;stop&gt;</code></p><p>例如：<code>lrange mylist 0 -1</code> 其中 0 表示左边第一个，-1 表示右边第一个，（<strong>0 -1 表示获取所有</strong>）</p></li><li><p>按照索引下标获得元素 (从左到右)：<code>lindex &lt;key&gt; &lt;index&gt;</code></p></li><li><p>获得列表长度：<code>llen &lt;key&gt;</code></p></li><li><p>在 <code>&lt;value&gt;</code> 的<strong>前面 / 后面</strong>插入 <code>&lt;newvalue&gt;</code> 的值：<code>linsert &lt;key&gt; before/after &lt;value&gt; &lt;newvalue&gt;</code></p></li><li><p>从左边删除 n 个值为 <code>&lt;value&gt;</code> 的值 (从左到右)：<code>lrem &lt;key&gt; &lt;n&gt; &lt;value&gt;</code></p></li><li><p>将列表 <code>&lt;key&gt;</code> 下标为 index 的值替换成 value：<code>lset &lt;key&gt; &lt;index&gt; &lt;value&gt;</code></p></li></ul><h3 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h3><p>List 的数据结构为<strong>快速链表 quickList</strong>。</p><p>首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构是 <strong>ziplist</strong>，也即是<strong>压缩列表</strong>。</p><p>它将所有的元素紧挨着一起存储，分配的是一块连续的内存。</p><p>当数据量比较多的时候才会改成 quicklist。</p><p>因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是 int 类型的数据，结构上还需要两个额外的指针 prev 和 next。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220407021204.png" srcset="/img/loading.gif" lazyload alt="image-20220407021204491"></p><p>Redis 将<strong>链表和 ziplist 结合起来组成了 quicklist</strong>。也就是将多个 ziplist 使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</p><h2 id="集合（Set）"><a href="#集合（Set）" class="headerlink" title="集合（Set）"></a>集合（Set）</h2><h3 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h3><p>Redis set 对外提供的功能与 list 类似是一个列表的功能，特殊之处在于 set 是可以<strong>自动排重</strong>的，当你需要存储一个列表数据，又不希望出现重复数据时，set 是一个很好的选择，并且 set 提供了判断某个成员是否在一个 set 集合内的重要接口，这个也是 list 所不能提供的。</p><p>Redis 的 Set 是 string 类型的无序集合。它底层其实是<strong>一个 value 为 null 的 hash 表</strong>，所以添加，删除，查找的 ** 复杂度都是 O (1)**。</p><p>一个算法，随着数据的增加，执行时间的长短，如果是 O (1)，数据增加，查找数据的时间不变</p><h3 id="常用命令-2"><a href="#常用命令-2" class="headerlink" title="常用命令"></a>常用命令</h3><ul><li>将一个或多个 member 元素加入到集合 key 中，已经存在的 member 元素将被忽略：<code>sadd &lt;key&gt; &lt;value1&gt; &lt;value2&gt; .....</code></li><li>取出该集合的所有值：<code>smembers &lt;key&gt;</code></li><li>判断集合 <code>&lt;key&gt;</code> 是否为含有该 <code>&lt;value&gt;</code> 值，有返回 1，没有返回 0：<code>sismember &lt;key&gt;&lt;value&gt;</code></li><li>返回该集合的元素个数：<code>scard &lt;key&gt;</code></li><li>删除集合中的某个元素：<code>srem &lt;key&gt; &lt;value1&gt; &lt;value2&gt; ....</code></li><li><strong>随机从该集合中移除并返回一个值</strong>：<code>spop &lt;key&gt;</code></li><li>随机从该集合中取出 n 个值。不会从集合中删除：<code>srandmember &lt;key&gt; &lt;n&gt;</code></li><li>把集合中一个值从一个集合移动到另一个集合：<code>smove &lt;source&gt; &lt;destination&gt; &lt;value&gt;</code></li><li>返回所有集合的<strong>交集</strong>元素：<code>sinter &lt;key1&gt; &lt;key2&gt;...</code></li><li>返回给定所有集合的交集并存储在 <code>&lt;destination&gt;</code> 中：<code>sinterstore &lt;destination&gt; &lt;key1&gt; &lt;key2&gt;...</code></li><li>返回所有集合的<strong>并集</strong>元素：<code>sunion &lt;key1&gt; &lt;key2&gt;...</code></li><li>所有给定集合的并集存储在 destination 集合中：<code>sunionstore &lt;destination&gt; &lt;key1&gt; &lt;key2&gt;...</code></li><li>返回第一个集合和其他集合的<strong>差集</strong>元素 (<code>&lt;key1&gt;</code> 中的，不包含 <code>&lt;key2&gt;</code> 中的)：<code>sdiff &lt;key1&gt; &lt;key2&gt;...</code></li><li>迭代集合中的元素：<code>sscan &lt;key&gt; cursor [match pattern] [count counts]</code></li></ul><h3 id="数据结构-2"><a href="#数据结构-2" class="headerlink" title="数据结构"></a>数据结构</h3><p>Set 数据结构是 dict 字典，字典是用哈希表实现的。</p><p>Java 中 HashSet 的内部实现使用的是 HashMap，只不过所有的 value 都指向同一个对象。Redis 的 set 结构也是一样，它的内部也使用 hash 结构，所有的 value 都指向同一个内部值。</p><h2 id="哈希（Hash）"><a href="#哈希（Hash）" class="headerlink" title="哈希（Hash）"></a>哈希（Hash）</h2><h3 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h3><p>Redis hash 是一个键值对集合。</p><p>Redis hash 是一个 string 类型的 <strong>field</strong> 和 <strong>value</strong> 的映射表，hash 特别适合用于存储对象。</p><p>类似 Java 里面的 Map&lt;String,Object&gt;</p><p>用户 ID 为查找的 key，存储的 value 用户对象包含姓名，年龄，生日等信息，如果用普通的 key/value 结构来存储，主要有以下 2 种存储方式：</p><ol><li><p>每次修改用户的某个属性需要，先反序列化改好后再序列化回去。开销较大。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220409134058.png" srcset="/img/loading.gif" lazyload alt="image-20220409134058598"></p></li><li><p>用户 ID 数据冗余</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220409134141.png" srcset="/img/loading.gif" lazyload alt="image-20220409134141235"></p></li></ol><p>而使用 hash 的情况下：</p><p><strong>通过 key (用户 ID) + field (属性标签) 就可以操作对应属性数据了，既不需要重复存储数据，也不会带来序列化和并发修改控制的问题</strong></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220409134535.png" srcset="/img/loading.gif" lazyload alt="image-20220409134535668"></p><h3 id="常用命令-3"><a href="#常用命令-3" class="headerlink" title="常用命令"></a>常用命令</h3><ul><li>给 <code>&lt;key&gt;</code> 集合中的 <code>&lt;field&gt;</code> 键赋值 <code>&lt;value&gt;</code>：<code>hset &lt;key&gt; &lt;field&gt; &lt;value&gt;</code></li><li>只有在字段 field 不存在时，<code>&lt;key&gt;</code> 集合中的 <code>&lt;field&gt;</code> 键赋值 <code>&lt;value&gt;</code>：<code>hsetnx &lt;key&gt; &lt;field&gt; &lt;value&gt;</code></li><li>从 <code>&lt;key&gt;</code> 集合 <code>&lt;field&gt;</code> 取出 value：<code>hget &lt;key&gt; &lt;field&gt;</code></li><li>批量设置 hash 的值：<code>hmset &lt;key1&gt; &lt;field1&gt; &lt;value1&gt; &lt;field2&gt; &lt;value2&gt;...</code></li><li>批量获得 hash 的值：<code>hmget &lt;key&gt; &lt;field1&gt; &lt;field2&gt;...</code></li><li>查看哈希表 <code>&lt;key&gt;</code> 中，给定域 <code>&lt;field&gt;</code> 是否存在：<code>hexists &lt;key&gt; &lt;field&gt;</code></li><li>删除一个或多个哈希表字段：<code>hdel &lt;key&gt; &lt;field1&gt; &lt;field2&gt;</code></li><li>列出该 hash 集合的所有的 <code>&lt;field&gt;</code>：<code>hkeys &lt;key&gt;</code></li><li>列出该 hash 集合的所有 <code>&lt;value&gt;</code>：<code>hvals &lt;key&gt;</code></li><li>为哈希表 <code>&lt;key&gt;</code> 中的域 <code>&lt;field&gt;</code> 的值加上增量 <code>&lt;increment&gt;</code>：<code>hincrby &lt;key&gt; &lt;field&gt; &lt;increment&gt;</code></li><li>为哈希表 key 中的指定字段的浮点数值加上增量 <code>&lt;increment&gt;</code> ：<code>hincrbyfloat &lt;key&gt; &lt;field&gt; &lt;increment&gt;</code></li><li>将哈希表 <code>&lt;key&gt;</code> 中的域 <code>&lt;field&gt;</code> 的值设置为 <code>&lt;value&gt;</code> ，当且仅当域 field 不存在：<code>hsetnx &lt;key&gt; &lt;field&gt; &lt;value&gt;</code></li><li>获取在哈希表中指定 <code>&lt;key&gt;</code> 的所有字段和值：<code>hgetall &lt;key&gt;</code></li><li>迭代哈希表中的键值对：<code>hscan &lt;key&gt; cursor [match pattern] [count counts]</code></li></ul><h3 id="数据结构-3"><a href="#数据结构-3" class="headerlink" title="数据结构"></a>数据结构</h3><p>Hash 类型对应的数据结构是两种：<strong>ziplist（压缩列表）</strong>，<strong>hashtable（哈希表）</strong>。当 field-value 长度较短且个数较少时，使用 ziplist，否则使用 hashtable</p><h2 id="有序集合（Zset）"><a href="#有序集合（Zset）" class="headerlink" title="有序集合（Zset）"></a>有序集合（Zset）</h2><h3 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h3><p>Redis 有序集合 zset 与普通集合 set 非常相似，是一个<strong>没有重复元素</strong>的字符串集合。</p><p>不同之处是有序集合的每个成员都关联了一个<strong>评分（score）</strong>, 这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。<strong>集合的成员是唯一的，但是评分可以是重复了</strong> 。</p><p>因为元素是有序的，所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</p><p>访问有序集合的中间元素也是非常快的，因此你能够使用有序集合作为一个没有重复成员的智能列表。</p><h3 id="常用命令-4"><a href="#常用命令-4" class="headerlink" title="常用命令"></a>常用命令</h3><ul><li>将一个或多个 member 元素及其 <code>&lt;score&gt;</code> 值加入到有序集 <code>&lt;key&gt;</code> 当中：<code>zadd &lt;key&gt; &lt;score1&gt; &lt;value1&gt; &lt;score2&gt; &lt;value&gt;...</code></li><li>返回有序集 <code>&lt;key&gt;</code> 中，下标在 <code>&lt;start&gt; &lt;stop&gt;</code> 之间的元素，按 <code>&lt;score&gt;</code> 值递增 (<strong>从小到大</strong>) 次序排列，带 withscores，可以让分数一起和值返回到结果集：<code>zrange &lt;key&gt; &lt;start&gt; &lt;stop&gt; [withscores]</code></li><li>返回有序集 <code>&lt;key&gt;</code> 中，下标在 <code>&lt;start&gt; &lt;stop&gt;</code> 之间的元素，按 <code>&lt;score&gt;</code> 值递增 (<strong>从大到小</strong>) 次序排列，带 withscores，可以让分数一起和值返回到结果集：<code>zrevrange &lt;key&gt; &lt;start&gt; &lt;stop&gt; [withscores]</code></li><li>返回有序集 <code>&lt;key&gt;</code> 中，所有 <code>&lt;score&gt;</code> 值介于 <code>&lt;min&gt;</code> 和 <code>&lt;max&gt;</code> 之间 (包括等于 min 或 max) 的成员。有序集成员按 <code>&lt;score&gt;</code> 值递增 (<strong>从小到大</strong>) 次序排列：<code>zrangebyscore &lt;key&gt; &lt;min&gt; &lt;max&gt; [withscores] [limit offset count]</code></li><li>返回有序集 <code>&lt;key&gt;</code> 中，所有 <code>&lt;score&gt;</code> 值介于 <code>&lt;min&gt;</code> 和 <code>&lt;max&gt;</code> 之间 (包括等于 min 或 max) 的成员。有序集成员按 <code>&lt;score&gt;</code> 值递增 (<strong>从大到小</strong>) 次序排列：<code>zrevrangebyscore &lt;key&gt; &lt;max&gt; &lt;min&gt; [withscores] [limit offset count]</code></li><li>为元素的 score 加上增量：<code>zincrby &lt;key&gt; &lt;increment&gt; &lt;value&gt;</code></li><li>删除该集合下，指定值的元素：<code>zrem &lt;key&gt; &lt;value1&gt; &lt;value2&gt;...</code></li><li>统计该集合，分数区间内的元素个数：<code>zcount &lt;key&gt; &lt;min&gt; &lt;max&gt;</code></li><li>返回该值在集合中的排名，按 <code>&lt;score&gt;</code> 值递增 (<strong>从小到大</strong>) 次序排列，从 0 开始：<code>zrank &lt;key&gt; &lt;value&gt;</code></li><li>返回该值在集合中的排名，按 <code>&lt;score&gt;</code> 值递增 (<strong>从大到小</strong>) 次序排列，从 0 开始：<code>zrevrank &lt;key&gt; &lt;value&gt;</code></li><li>获取有序集合的成员数：<code>zcard key</code></li><li>计算给定的一个或多个有序集的交集并将结果集存储在新的有序集合 <code>&lt;destination&gt;</code> 中：<code>zinterstore &lt;destination&gt; &lt;numkeys&gt; &lt;key1&gt; &lt;key2&gt; ...</code></li><li>在有序集合中计算指定字典区间内成员数量：<code>zlexcount &lt;key&gt; &lt;min&gt; &lt;max&gt;</code><ul><li>成员名称前需要加 <code>[</code> 符号作为开头，<code>[</code> 符号与成员之间不能有空格</li><li>可以使用 <code>-</code> 和 <code>+</code> 表示得分最小值和最大值</li></ul></li><li>通过字典区间返回有序集合的成员：<code>zrangebylex &lt;key&gt; &lt;min&gt; &lt;max&gt; [limit offset count]</code><ul><li>成员名称前需要加 <code>[</code> 符号作为开头，<code>[</code> 符号与成员之间不能有空格，<code>(</code>符号表示不包含</li><li>可以使用 <code>-</code> 和 <code>+</code> 表示得分最小值和最大值</li></ul></li><li>移除有序集合中给定的字典区间的所有成员：<code>zremrangebylex &lt;key&gt; &lt;min&gt; &lt;max&gt;</code><ul><li>成员名称前需要加 <code>[</code> 符号作为开头，<code>[</code> 符号与成员之间不能有空格</li><li>可以使用 <code>-</code> 和 <code>+</code> 表示得分最小值和最大值</li></ul></li><li>移除有序集合中给定的排名区间的所有成员：<code>zremrangebyrank &lt;key&gt; &lt;start&gt; &lt;stop&gt;</code></li><li>移除有序集合中给定的分数区间的所有成员：<code>zremrangebyscore &lt;key&gt; &lt;min&gt; &lt;max&gt;</code></li><li>返回有序集中，成员的分数值：<code>zcore &lt;key&gt; &lt;value&gt;</code></li><li>计算给定的一个或多个有序集的并集，并存储在 <code>&lt;destination&gt;</code> 中：<code>zunionstore &lt;destination&gt; &lt;numkeys&gt; &lt;key1&gt; &lt;key2&gt; ...</code></li><li>迭代有序集合中的元素（包括元素成员和元素分值）：<code>zscan &lt;key&gt; cursor [match pattern] [count counts]</code></li></ul><h3 id="数据结构-4"><a href="#数据结构-4" class="headerlink" title="数据结构"></a>数据结构</h3><p>SortedSet (zset) 是 Redis 提供的一个非常特别的数据结构，一方面它等价于 Java 的数据结构 Map&lt;String, Double&gt;，可以给每一个元素 value 赋予一个权重 score，另一方面它又类似于 TreeSet，内部的元素会按照权重 score 进行排序，可以得到每个元素的名次，还可以通过 score 的范围来获取元素的列表。</p><p>zset 底层使用了两个数据结构：</p><ol><li>hash，hash 的作用就是关联元素 value 和权重 score，保障元素 value 的唯一性，可以通过元素 value 找到相应的 score 值。</li><li>跳跃表，跳跃表的目的在于给元素 value 排序，根据 score 的范围获取元素列表。</li></ol><h2 id="跳跃表（跳表）"><a href="#跳跃表（跳表）" class="headerlink" title="跳跃表（跳表）"></a><strong>跳跃表（跳表）</strong></h2><h3 id="简介-5"><a href="#简介-5" class="headerlink" title="简介"></a>简介</h3><p>有序集合在生活中比较常见，例如根据成绩对学生排名，根据得分对玩家排名等。对于有序集合的底层实现，可以用数组、平衡树、链表等。数组不便元素的插入、删除；平衡树或红黑树虽然效率高但结构复杂；链表查询需要遍历所有效率低。Redis 采用的是跳跃表。跳跃表效率堪比红黑树，实现远比红黑树简单。</p><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>对比有序链表和跳跃表，从链表中查询出 51</p><ol><li>有序链表</li></ol><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220410020855.png" srcset="/img/loading.gif" lazyload alt="image-20220410020855417"></p><p>要查找值为 51 的元素，需要从第一个元素开始依次查找、比较才能找到。共需要 6 次比较。</p><ol start="2"><li><p>跳跃表</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220410131600.jpg" srcset="/img/loading.gif" lazyload alt="image-20220410131600"></p><p>从第 2 层开始，1 节点比 41 节点小，向后比较。21 节点比 51 节点小，继续向后比较，后面就是 NULL 了，所以从 21 节点向下到第 1 层</p><p>在第 1 层，41 节点比 51 节点小，继续向后，61 节点比 51 节点大，所以从 41 节点向下</p><p>在第 0 层，51 节点为要查找的节点，节点被找到，共查找 4 次。</p></li></ol><h1 id="Redis-配置文件"><a href="#Redis-配置文件" class="headerlink" title="Redis 配置文件"></a>Redis 配置文件</h1><p>自定义目录：/etc/redis.conf</p><h2 id="Units-单位"><a href="#Units-单位" class="headerlink" title="Units 单位"></a>Units 单位</h2><p>配置大小单位，开头定义了一些基本的度量单位，只支持 bytes，不支持 bit<br>大小写不敏感</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220410225355.png" srcset="/img/loading.gif" lazyload alt="image-20220410225355826"></p><h2 id="INCLUDES-包含"><a href="#INCLUDES-包含" class="headerlink" title="INCLUDES 包含"></a>INCLUDES 包含</h2><p>类似 jsp 中的 include，多实例的情况可以把公用的配置文件提取出来</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220410225510.png" srcset="/img/loading.gif" lazyload alt="image-20220410225510320"></p><h2 id="网络相关配置"><a href="#网络相关配置" class="headerlink" title="网络相关配置"></a>网络相关配置</h2><h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h3><p>默认情况 bind=127.0.0.1 只能接受本机的访问请求<br>不写的情况下，无限制接受任何 ip 地址的访问<br>生产环境肯定要写你应用服务器的地址；服务器是需要远程访问的，所以需要将其<strong>注释掉</strong></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220410225644.png" srcset="/img/loading.gif" lazyload alt="image-20220410225644567"></p><h3 id="protected-mode"><a href="#protected-mode" class="headerlink" title="protected-mode"></a>protected-mode</h3><p><strong>如果开启了 protected-mode，那么在没有设定 bind ip 且没有设密码的情况下，Redis 只允许接受本机的响应，需要将其改为 no</strong></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411015319.png" srcset="/img/loading.gif" lazyload alt="image-20220411015319271"></p><h3 id="tcp-backlog"><a href="#tcp-backlog" class="headerlink" title="tcp-backlog"></a>tcp-backlog</h3><p>设置 tcp 的 backlog，backlog 其实是一个连接队列，backlog 队列总和 = 未完成三次握手队列 + 已经完成三次握手队列。</p><p>在高并发环境下你需要一个高 backlog 值来避免慢客户端连接问题。</p><p>注意 Linux 内核会将这个值减小到 /proc/sys/net/core/somaxconn 的值（128），所以需要确认增大 /proc/sys/net/core/somaxconn 和 /proc/sys/net/ipv4/tcp_max_syn_backlog（128）两个值来达到想要的效果</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411020630.png" srcset="/img/loading.gif" lazyload alt="image-20220411020630898"></p><h3 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h3><p>一个空闲的客户端维持多少秒会关闭，0 表示关闭该功能。即<strong>永不关闭</strong>。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411020728.png" srcset="/img/loading.gif" lazyload alt="image-20220411020728892"></p><h3 id="tcp-keepalive"><a href="#tcp-keepalive" class="headerlink" title="tcp-keepalive"></a>tcp-keepalive</h3><p>对访问客户端的一种<strong>心跳检测</strong>，每个 n 秒检测一次。</p><p>单位为秒，如果设置为 0，则不会进行 Keepalive 检测，建议设置成 60</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411020803.png" srcset="/img/loading.gif" lazyload alt="image-20220411020803546"></p><h2 id="GENERAL-通用"><a href="#GENERAL-通用" class="headerlink" title="GENERAL 通用"></a>GENERAL 通用</h2><h3 id="daemonize"><a href="#daemonize" class="headerlink" title="daemonize"></a>daemonize</h3><p>是否为后台进程，设置为 yes</p><p>守护进程，后台启动</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411020857.png" srcset="/img/loading.gif" lazyload alt="image-20220411020857831"></p><h3 id="pidfile"><a href="#pidfile" class="headerlink" title="pidfile"></a>pidfile</h3><p>存放 pid 文件的位置，每个实例会产生一个不同的 pid 文件</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411020927.png" srcset="/img/loading.gif" lazyload alt="image-20220411020927003"></p><h3 id="loglevel"><a href="#loglevel" class="headerlink" title="loglevel"></a>loglevel</h3><p>指定日志记录级别，Redis 总共支持四个级别：debug、verbose、notice、warning，默认为 notice</p><p>四个级别根据使用阶段来选择，生产环境选择 notice 或者 warning</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411021005.png" srcset="/img/loading.gif" lazyload alt="image-20220411021005540"></p><h3 id="logfile"><a href="#logfile" class="headerlink" title="logfile"></a>logfile</h3><p>日志文件名称</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411021104.png" srcset="/img/loading.gif" lazyload alt="image-20220411021103939"></p><h3 id="databases"><a href="#databases" class="headerlink" title="databases"></a>databases</h3><p><strong>设定库的数量 默认 16</strong>，默认数据库为 0，可以使用 SELECT 命令在连接上指定数据库 id</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411021134.png" srcset="/img/loading.gif" lazyload alt="image-20220411021133989"></p><h2 id="SECURITY-安全"><a href="#SECURITY-安全" class="headerlink" title="SECURITY 安全"></a>SECURITY 安全</h2><h3 id="设置密码"><a href="#设置密码" class="headerlink" title="设置密码"></a>设置密码</h3><p>访问密码的查看、设置和取消</p><p>在命令中设置密码，只是临时的。重启 redis 服务器，密码就还原了</p><p>永久设置，需要在配置文件中进行设置</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411021309.png" srcset="/img/loading.gif" lazyload alt="image-20220411021309192"></p><h2 id="LIMITS-限制"><a href="#LIMITS-限制" class="headerlink" title="LIMITS 限制"></a>LIMITS 限制</h2><h3 id="maxclients"><a href="#maxclients" class="headerlink" title="maxclients"></a>maxclients</h3><p>设置 redis 同时可以与多少个客户端进行连接</p><p>默认情况下为 10000 个客户端。</p><p>如果达到了此限制，redis 则会拒绝新的连接请求，并且向这些连接请求方发出 “max number of clients reached” 以作回应。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411021644.png" srcset="/img/loading.gif" lazyload alt="image-20220411021644289"></p><h3 id="maxmemory"><a href="#maxmemory" class="headerlink" title="maxmemory"></a>maxmemory</h3><p>建议必须设置，否则，将内存占满，造成服务器宕机</p><p>设置 redis 可以使用的内存量。一旦到达内存使用上限，redis 将会试图移除内部数据，移除规则可以通过 maxmemory-policy 来指定。</p><p>如果 redis 无法根据移除规则来移除内存中的数据，或者设置了 “不允许移除”，那么 redis 则会针对那些需要申请内存的指令返回错误信息，比如 SET、LPUSH 等。</p><p>但是对于无内存申请的指令，仍然会正常响应，比如 GET 等。如果你的 redis 是主 redis（说明你的 redis 有从 redis），那么在设置内存使用上限时，需要在系统中留出一些内存空间给同步队列缓存，只有在你设置的是 “不移除” 的情况下，才不用考虑这个因素。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411021734.png" srcset="/img/loading.gif" lazyload alt="image-20220411021733993"></p><h3 id="maxmemory-policy"><a href="#maxmemory-policy" class="headerlink" title="maxmemory-policy"></a>maxmemory-policy</h3><p>volatile-lru：使用 LRU 算法移除 key，只对设置了过期时间的键；（最近最少使用）</p><p>allkeys-lru：在所有集合 key 中，使用 LRU 算法移除 key</p><p>volatile-random：在过期集合中移除随机的 key，只对设置了过期时间的键</p><p>allkeys-random：在所有集合 key 中，移除随机的 key</p><p>volatile-ttl：移除那些 TTL 值最小的 key，即那些最近要过期的 key</p><p>noeviction：不进行移除。针对写操作，只是返回错误信息</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411021938.png" srcset="/img/loading.gif" lazyload alt="image-20220411021937910"></p><h3 id="maxmemory-samples"><a href="#maxmemory-samples" class="headerlink" title="maxmemory-samples"></a>maxmemory-samples</h3><p>设置样本数量，LRU 算法和最小 TTL 算法都并非是精确的算法，而是估算值，所以你可以设置样本的大小，redis 默认会检查这么多个 key 并选择其中 LRU 的那个。</p><p>一般设置 3 到 7 的数字，数值越小样本越不准确，但性能消耗越小。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411022320.png" srcset="/img/loading.gif" lazyload alt="image-20220411022320100"></p><h1 id="Redis-的发布和订阅"><a href="#Redis-的发布和订阅" class="headerlink" title="Redis 的发布和订阅"></a>Redis 的发布和订阅</h1><h2 id="什么是发布和订阅"><a href="#什么是发布和订阅" class="headerlink" title="什么是发布和订阅"></a>什么是发布和订阅</h2><p>Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。</p><p>Redis 客户端可以订阅任意数量的频道。</p><h2 id="Redis-的发布和订阅-1"><a href="#Redis-的发布和订阅-1" class="headerlink" title="Redis 的发布和订阅"></a>Redis 的发布和订阅</h2><ol><li><p>客户端可以订阅频道</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411022626.png" srcset="/img/loading.gif" lazyload alt="image-20220411022626452"></p></li><li><p>当给这个频道发布消息后，消息就会发送给订阅的客户端</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411022635.png" srcset="/img/loading.gif" lazyload alt="image-20220411022635647"></p></li></ol><h2 id="发布订阅命令行实现"><a href="#发布订阅命令行实现" class="headerlink" title="发布订阅命令行实现"></a>发布订阅命令行实现</h2><ol><li><p>打开一个客户端订阅 channel1：<code>subscribe channel1</code></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411022818.png" srcset="/img/loading.gif" lazyload alt="image-20220411022818765"></p></li><li><p>打开另一个客户端，给 channel1 发布消息 hello (返回的 1 是订阅者数量)：<code>publish channel1 hello</code></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411022937.png" srcset="/img/loading.gif" lazyload alt="image-20220411022937078"></p></li><li><p>打开第一个客户端可以看到发送的消息</p><p>注：发布的消息没有持久化，如果在订阅的客户端收不到 hello，只能收到订阅后发布的消息</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411023030.png" srcset="/img/loading.gif" lazyload alt="image-20220411023030235"></p></li></ol><h1 id="Redis-新数据类型"><a href="#Redis-新数据类型" class="headerlink" title="Redis 新数据类型"></a>Redis 新数据类型</h1><h2 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h2><h3 id="简介-6"><a href="#简介-6" class="headerlink" title="简介"></a>简介</h3><p>现代计算机用二进制（位） 作为信息的基础单位， 1 个字节等于 8 位， 例如 “abc” 字符串是由 3 个字节组成， 但实际在计算机存储时将其用二进制表示。合理地使用操作位能够有效地提高内存使用率和开发效率。</p><p>Redis 提供了 Bitmaps 这个 “数据类型” 可以实现对位的操作：</p><ol><li>Bitmaps 本身不是一种数据类型， 实际上它就是字符串（key-value） ， 但是它可以对字符串的位进行操作。</li><li>Bitmaps 单独提供了一套命令， 所以在 Redis 中使用 Bitmaps 和使用字符串的方法不太相同。可以把 Bitmaps 想象成一个以位为单位的数组， 数组的每个单元只能存储 0 和 1， 数组的下标在 Bitmaps 中叫做偏移量。</li></ol><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220411023225.png" srcset="/img/loading.gif" lazyload alt="image-20220411023225140"></p><h3 id="常用命令-5"><a href="#常用命令-5" class="headerlink" title="常用命令"></a>常用命令</h3><ul><li><p>设置 Bitmaps 中某个偏移量的值（0 或 1）（offset: 偏移量从 0 开始）：<code>setbit &lt;key&gt; &lt;offset&gt; &lt;value&gt;</code></p><p>实例：<br>每个独立用户是否访问过网站存放在 Bitmaps 中， 将访问的用户记做 1， 没有访问的用户记做 0， 用偏移量作为用户的 id。</p><p><strong>注意</strong>：<br>很多应用的用户 id 以一个指定数字（例如 10000） 开头， 直接将用户 id 和 Bitmaps 的偏移量对应势必会造成一定的浪费， 通常的做法是每次做 setbit 操作时将用户 id 减去这个指定数字。</p><p>在第一次初始化 Bitmaps 时， 假如偏移量非常大， 那么整个初始化过程执行会比较慢， 可能会造成 Redis 的阻塞。</p></li><li><p>获取 Bitmaps 中某个偏移量的值：<code>getbit &lt;key&gt; &lt;offset&gt;</code></p><p>若访问的 bit 不存在，则返回 0 。</p></li><li><p>统计<strong>字符串</strong>被设置为 1 的 bit 数：<code>bitcount &lt;key&gt;[start end]</code></p><p>注意：redis 的 setbit 设置或清除的是 bit 位置，而 bitcount 计算的是 byte 位置。</p></li><li><p>对 Bitmaps 进行 and（交集） 、 or（并集） 、 not（非） 、 xor（异或） 操作并将结果保存在 destkey 中：<code>bitop and(or/not/xor) &lt;destkey&gt; &lt;key1&gt; &lt;key2&gt;...</code></p></li></ul><h3 id="Bitmaps与set对比"><a href="#Bitmaps与set对比" class="headerlink" title="Bitmaps与set对比"></a>Bitmaps 与 set 对比</h3><p>假设网站有 1 亿用户， 每天独立访问的用户有 5 千万， 如果每天用 set 类型和 Bitmaps 分别存储活跃用户，可以得到 set 类型占用空间： <strong>64 位 * 5 千万 = 400MB</strong> ，而 Bitmaps 占用空间：<strong>1 位 * 1 亿 = 12.5MB</strong>。</p><p>很明显， 这种情况下使用 Bitmaps 能节省很多的内存空间， 尤其是随着时间推移节省的内存还是非常可观的。</p><p>但 Bitmaps 并不是万金油， 假如该网站每天的独立访问用户很少， 例如只有 10 万（大量的僵尸用户） ， 那么两者的对比如下表所示， 很显然， 这时候使用 Bitmaps 就不太合适了， 因为基本上大部分位都是 0。可以得到 set 类型占用空间： <strong>64 位 * 10 万 = 800KB</strong> ，而 Bitmaps 占用空间：<strong>1 位 * 1 亿 = 12.5MB</strong>。</p><h2 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h2><h3 id="简介-7"><a href="#简介-7" class="headerlink" title="简介"></a>简介</h3><p>在工作当中，我们经常会遇到与统计相关的功能需求，比如统计网站 PV（PageView 页面访问量）, 可以使用 Redis 的 incr、incrby 轻松实现。</p><p>但像 UV（UniqueVisitor，独立访客）、独立 IP 数、搜索记录数等需要去重和计数的问题如何解决？这种求集合中不重复元素个数的问题称为基数问题。</p><p><strong>解决基数问题有很多种方案</strong>：<br>（1）数据存储在 MySQL 表中，使用 distinct count 计算不重复个数<br>（2）使用 Redis 提供的 hash、set、bitmaps 等数据结构来处理</p><p>以上的方案结果精确，但随着数据不断增加，导致占用空间越来越大，对于非常大的数据集是不切实际的。</p><p><strong>能否能够降低一定的精度来平衡存储空间</strong>？</p><p>Redis 推出了 HyperLogLog</p><p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p><p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p><p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而<strong>不会储存输入元素本身</strong>，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p><p><strong>什么是基数？</strong><br>比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数 (不重复元素) 为 5。 基数估计就是在误差可接受的范围内，快速计算基数。</p><h3 id="常用命令-6"><a href="#常用命令-6" class="headerlink" title="常用命令"></a>常用命令</h3><ul><li>添加指定元素到 HyperLogLog 中，如果执行命令后 HLL 估计的近似基数发生变化，则返回 1，否则返回 0：<code>pfadd &lt;key&gt; &lt;element1&gt; &lt;element2&gt;...</code></li><li><strong>计算 HLL 的近似基数</strong>，可以计算多个 HLL，比如用 HLL 存储每天的 UV，计算一周的 UV 可以使用 7 天的 UV 合并计算即可：<code>pfcount &lt;key1&gt; &lt;key2&gt;...</code></li><li>将一个或多个 HLL 合并后的结果存储在另一个 HLL 中，比如每月活跃用户可以使用每天的活跃用户来合并计算可得：<code>pfmerge &lt;destkey&gt; &lt;sourcekey1&gt; &lt;sourcekey2&gt;...</code></li></ul><h2 id="Geospatial"><a href="#Geospatial" class="headerlink" title="Geospatial"></a>Geospatial</h2><h3 id="简介-8"><a href="#简介-8" class="headerlink" title="简介"></a>简介</h3><p>Redis 3.2 中增加了对 GEO 类型的支持。GEO，Geographic，地理信息的缩写。该类型，就是元素的 2 维坐标，在地图上就是经纬度。redis 基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度 Hash 等常见操作。</p><h3 id="常用命令-7"><a href="#常用命令-7" class="headerlink" title="常用命令"></a>常用命令</h3><ul><li><p>添加地理位置（经度，纬度，名称）：<code>geoadd &lt;key&gt; &lt;longitude&gt; &lt;latitude&gt; &lt;member&gt; [longitude latitude member...]</code></p><p>两极无法直接添加，一般会下载城市数据，直接通过 Java 程序一次性导入。</p><p>有效的经度从 -180 度到 180 度。有效的纬度从 -85.05112878 度到 85.05112878 度。</p><p>当坐标位置超出指定范围时，该命令将会返回一个错误。</p><p>已经添加的数据，是无法再次往里面添加的。</p></li><li><p>获得指定地区的坐标值：<code>geopos &lt;key&gt; &lt;member&gt; [member...]</code></p></li><li><p>获取两个位置之间的直线距离：<code>geodist&lt;key&gt; &lt;member1&gt; &lt;member2&gt; [m|km|ft|mi]</code></p><ul><li>m 表示单位为米 [默认值]。</li><li>km 表示单位为千米。</li><li>mi 表示单位为英里。</li><li>ft 表示单位为英尺。</li><li>如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位</li></ul></li><li><p>以给定的经纬度为中心，找出某一半径内的元素：<code>georadius &lt;key&gt;&lt;longitude&gt; &lt;latitude&gt; &lt;半径&gt; m|km|ft|mi</code></p><ul><li>m 表示单位为米 [默认值]。</li><li>km 表示单位为千米。</li><li>mi 表示单位为英里。</li><li>ft 表示单位为英尺。</li><li>如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位</li></ul></li></ul><h1 id="Jedis-测试"><a href="#Jedis-测试" class="headerlink" title="Jedis 测试"></a>Jedis 测试</h1><h2 id="Jedis-所需的-jar-包"><a href="#Jedis-所需的-jar-包" class="headerlink" title="Jedis 所需的 jar 包"></a>Jedis 所需的 jar 包</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><h2 id="hutools工具包"><a href="#hutools工具包" class="headerlink" title="hutools工具包"></a>hutools 工具包</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.0.M2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><h2 id="连接-Redis-注意事项"><a href="#连接-Redis-注意事项" class="headerlink" title="连接 Redis 注意事项"></a>连接 Redis 注意事项</h2><ul><li>禁用 Linux 的防火墙：Linux (CentOS7) 里执行命令：<code>systemctl stop firewalld.service</code></li><li>执行开机禁用防火墙自启命令 ： <code>systemctl disable firewalld.service</code></li><li>查看防火墙命令：<code>systemctl status firewalld.service</code></li><li>redis.conf 中注释掉 <code>bind 127.0.0.1</code>，更改 <code>protected-mode no</code></li><li>关闭 redis server：<code>redis-cli -h 127.0.0.1 -p 6379 -a 密码 shutdown</code></li><li>重启 redis server：<code>/usr/local/bin/redis-server /etc/redis.conf</code></li></ul><h2 id="测试程序"><a href="#测试程序" class="headerlink" title="测试程序"></a>测试程序</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.zlw.jedis;<br><br><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * project : redis-study-jedis</span><br><span class="hljs-comment"> * description : jedis测试01</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> AWEI</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022-04-13【星期三】</span><br><span class="hljs-comment"> **/</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisDemo01</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(String[] args)</span> {<br>        <span class="hljs-comment">//创建Jedis对象</span><br>        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"192.168.137.130"</span>, <span class="hljs-number">6379</span>);<br><br>        <span class="hljs-comment">//密码认证</span><br>        jedis.auth(<span class="hljs-string">"root"</span>);<br><br>        <span class="hljs-comment">//测试</span><br>        System.out.println(jedis.ping());<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><strong>测试结果</strong>：</p><p>返回 “PONG” ，则表示连接成功。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413011409.png" srcset="/img/loading.gif" lazyload alt="image-20220413011409350"></p><h2 id="测试相关数据类型"><a href="#测试相关数据类型" class="headerlink" title="测试相关数据类型"></a>测试相关数据类型</h2><h3 id="Jedis-API：Key"><a href="#Jedis-API：Key" class="headerlink" title="Jedis-API：Key"></a>Jedis-API：Key</h3><ul><li><p>测试代码</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//操作key</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo01</span> <span class="hljs-params">()</span> {<br>    <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.get();<br>    <span class="hljs-comment">//创建Jedis对象</span><br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"192.168.137.130"</span>, <span class="hljs-number">6379</span>);<br>    <span class="hljs-comment">//密码认证</span><br>    jedis.auth(<span class="hljs-string">"root"</span>);<br><br>    <span class="hljs-comment">//设置key</span><br>    jedis.set(<span class="hljs-string">"k1"</span>, <span class="hljs-string">"v1"</span>);<br>    jedis.set(<span class="hljs-string">"k2"</span>, <span class="hljs-string">"v2"</span>);<br>    jedis.set(<span class="hljs-string">"k3"</span>, <span class="hljs-string">"v3"</span>);<br><br>    <span class="hljs-comment">//获得所有的key</span><br>    Set&lt;String&gt; keys = jedis.keys(<span class="hljs-string">"*"</span>);<br>    <span class="hljs-comment">//获得key的数量</span><br>    log.info(<span class="hljs-string">"获得key的数量"</span>);<br>    System.out.println(keys.size());<br><br>    log.info(<span class="hljs-string">"遍历打印keys"</span>);<br>    <span class="hljs-comment">//遍历打印keys</span><br>    <span class="hljs-keyword">for</span> (String key : keys) {<br>        System.out.println(key);<br>    }<br><br>    <span class="hljs-comment">//检测key是否存在</span><br>    log.info(<span class="hljs-string">"检测key是否存在"</span>);<br>    System.out.println(jedis.exists(<span class="hljs-string">"k1"</span>));<br><br>    <span class="hljs-comment">//查看key的剩余时间</span><br>    log.info(<span class="hljs-string">"查看key的剩余时间"</span>);<br>    System.out.println(jedis.ttl(<span class="hljs-string">"k1"</span>));<br><br>    <span class="hljs-comment">//获得key对应的value</span><br>    log.info(<span class="hljs-string">"获得key对应的value"</span>);<br>    System.out.println(jedis.get(<span class="hljs-string">"k1"</span>));<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>测试结果</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413015527.png" srcset="/img/loading.gif" lazyload alt="image-20220413015527640"></p></li></ul><h3 id="Jedis-API：String"><a href="#Jedis-API：String" class="headerlink" title="Jedis-API：String"></a>Jedis-API：String</h3><ul><li><p>测试代码</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//操作string</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo02</span> <span class="hljs-params">()</span> {<br>    <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.get();<br>    <span class="hljs-comment">//创建Jedis对象</span><br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"192.168.137.130"</span>, <span class="hljs-number">6379</span>);<br>    <span class="hljs-comment">//密码认证</span><br>    jedis.auth(<span class="hljs-string">"root"</span>);<br><br>    <span class="hljs-comment">//设置多个 string 的 key-value</span><br>    jedis.mset(<span class="hljs-string">"str1"</span>, <span class="hljs-string">"v1"</span>, <span class="hljs-string">"str2"</span>, <span class="hljs-string">"v2"</span>, <span class="hljs-string">"str3"</span>, <span class="hljs-string">"v3"</span>);<br>    <br>    <span class="hljs-comment">//打印获得的 key-value</span><br>    log.info(<span class="hljs-string">"打印获得的 key-value"</span>);<br>    System.out.println(jedis.mget(<span class="hljs-string">"str1"</span>, <span class="hljs-string">"str2"</span>, <span class="hljs-string">"str3"</span>));<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>测试结果</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413020214.png" srcset="/img/loading.gif" lazyload alt="image-20220413020214277"></p></li></ul><h3 id="Jedis-API：list"><a href="#Jedis-API：list" class="headerlink" title="Jedis-API：list"></a>Jedis-API：list</h3><ul><li><p>测试代码</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//操作list</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo03</span> <span class="hljs-params">()</span> {<br>    <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.get();<br>    <span class="hljs-comment">//创建Jedis对象</span><br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"192.168.137.130"</span>, <span class="hljs-number">6379</span>);<br>    <span class="hljs-comment">//密码认证</span><br>    jedis.auth(<span class="hljs-string">"root"</span>);<br><br>    <span class="hljs-comment">//设置 list 的 key-value</span><br>    jedis.lpush(<span class="hljs-string">"myList"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>);<br>    <span class="hljs-comment">//获取list</span><br>    List&lt;String&gt; list = jedis.lrange(<span class="hljs-string">"myList"</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//遍历输出list里的value</span><br>    log.info(<span class="hljs-string">"遍历输出list里的value"</span>);<br>    <span class="hljs-keyword">for</span> (String element : list) {<br>        System.out.println(element);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>测试结果</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413021911.png" srcset="/img/loading.gif" lazyload alt="image-20220413021911595"></p></li></ul><h3 id="Jedis-API：set"><a href="#Jedis-API：set" class="headerlink" title="Jedis-API：set"></a>Jedis-API：set</h3><ul><li><p>测试代码</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//操作set</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo04</span> <span class="hljs-params">()</span> {<br>    <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.get();<br>    <span class="hljs-comment">//创建Jedis对象</span><br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"192.168.137.130"</span>, <span class="hljs-number">6379</span>);<br>    <span class="hljs-comment">//密码认证</span><br>    jedis.auth(<span class="hljs-string">"root"</span>);<br><br>    <span class="hljs-comment">//设置 set 的 key-value</span><br>    jedis.sadd(<span class="hljs-string">"orders"</span>, <span class="hljs-string">"order01"</span>,<span class="hljs-string">"order02"</span>,<span class="hljs-string">"order03"</span>,<span class="hljs-string">"order04"</span>);<br>    <span class="hljs-comment">//获取set中所有的值</span><br>    Set&lt;String&gt; smembers = jedis.smembers(<span class="hljs-string">"orders"</span>);<br>    <span class="hljs-comment">//遍历输出set中所有的值</span><br>    log.info(<span class="hljs-string">"遍历输出set中所有的值"</span>);<br>    <span class="hljs-keyword">for</span> (String order : smembers) {<br>        System.out.println(order);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>测试结果</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413022151.png" srcset="/img/loading.gif" lazyload alt="image-20220413022151586"></p></li></ul><h3 id="Jedis-API：hash"><a href="#Jedis-API：hash" class="headerlink" title="Jedis-API：hash"></a>Jedis-API：hash</h3><ul><li><p>测试代码</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//操作hash</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo05</span> <span class="hljs-params">()</span> {<br>    <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.get();<br>    <span class="hljs-comment">//创建Jedis对象</span><br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"192.168.137.130"</span>, <span class="hljs-number">6379</span>);<br>    <span class="hljs-comment">//密码认证</span><br>    jedis.auth(<span class="hljs-string">"root"</span>);<br><br>    <span class="hljs-comment">//设置 hash 中的 key-field-value</span><br>    jedis.hset(<span class="hljs-string">"hash1"</span>, <span class="hljs-string">"userName"</span>, <span class="hljs-string">"李四"</span>);<br>    <span class="hljs-comment">//输出hash里的值</span><br>    log.info(<span class="hljs-string">"输出hash里的值"</span>);<br>    System.out.println(jedis.hget(<span class="hljs-string">"hash1"</span>, <span class="hljs-string">"userName"</span>));<br><br>    <span class="hljs-comment">//使用Map集合存放需要输入hash的值</span><br>    Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br>    map.put(<span class="hljs-string">"phone"</span>, <span class="hljs-string">"188xxxxxxxx"</span>);<br>    map.put(<span class="hljs-string">"address"</span>, <span class="hljs-string">"广东"</span>);<br>    map.put(<span class="hljs-string">"email"</span>, <span class="hljs-string">"xxx@163.com"</span>);<br><br>    <span class="hljs-comment">//设置 hash 中的 key-field-value</span><br>    jedis.hmset(<span class="hljs-string">"hash2"</span>, map);<br><br>    <span class="hljs-comment">//获取hash里的值</span><br>    List&lt;String&gt; result = jedis.hmget(<span class="hljs-string">"hash2"</span>, <span class="hljs-string">"phone"</span>, <span class="hljs-string">"address"</span>, <span class="hljs-string">"email"</span>);<br><br>    <span class="hljs-comment">//遍历输出hash中所有的值</span><br>    log.info(<span class="hljs-string">"遍历输出hash中所有的值"</span>);<br>    <span class="hljs-keyword">for</span> (String element : result) {<br>        System.out.println(element);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>测试结果</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413023119.png" srcset="/img/loading.gif" lazyload alt="image-20220413023119111"></p></li></ul><h3 id="Jedis-API：zset"><a href="#Jedis-API：zset" class="headerlink" title="Jedis-API：zset"></a>Jedis-API：zset</h3><ul><li><p>测试代码</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//操作zset</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo06</span> <span class="hljs-params">()</span> {<br>    <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.get();<br>    <span class="hljs-comment">//创建Jedis对象</span><br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"192.168.137.130"</span>, <span class="hljs-number">6379</span>);<br>    <span class="hljs-comment">//密码认证</span><br>    jedis.auth(<span class="hljs-string">"root"</span>);<br><br>    <span class="hljs-comment">//设置 zset 的 key-value</span><br>    jedis.zadd(<span class="hljs-string">"zset01"</span>, <span class="hljs-number">100d</span>, <span class="hljs-string">"z3"</span>);<br>    jedis.zadd(<span class="hljs-string">"zset01"</span>, <span class="hljs-number">90d</span>, <span class="hljs-string">"l4"</span>);<br>    jedis.zadd(<span class="hljs-string">"zset01"</span>, <span class="hljs-number">80d</span>, <span class="hljs-string">"w5"</span>);<br>    jedis.zadd(<span class="hljs-string">"zset01"</span>, <span class="hljs-number">70d</span>, <span class="hljs-string">"z6"</span>);<br>    <span class="hljs-comment">//获取zset中所有的值</span><br>    List&lt;String&gt; zrange = jedis.zrange(<span class="hljs-string">"zset01"</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//遍历输出set中所有的值</span><br>    log.info(<span class="hljs-string">"遍历输出zset中所有的值"</span>);<br>    <span class="hljs-keyword">for</span> (String e : zrange) {<br>        System.out.println(e);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>测试结果</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413023411.png" srcset="/img/loading.gif" lazyload alt="image-20220413023411339"></p></li></ul><h1 id="Jedis-实例：手机验证码功能"><a href="#Jedis-实例：手机验证码功能" class="headerlink" title="Jedis 实例：手机验证码功能"></a>Jedis 实例：手机验证码功能</h1><blockquote><p>要求：</p><ol><li>输入手机号，点击发送后随机生成 6 位数字码，2 分钟有效</li><li>输入验证码，点击验证，返回成功或失败</li><li>每个手机号每天只能输入 3 次</li></ol></blockquote><ul><li><p>测试代码</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.zlw.jedis;<br><br><span class="hljs-keyword">import</span> cn.hutool.core.date.DateTime;<br><span class="hljs-keyword">import</span> cn.hutool.core.date.DateUnit;<br><span class="hljs-keyword">import</span> cn.hutool.core.date.DateUtil;<br><span class="hljs-keyword">import</span> cn.hutool.core.util.RandomUtil;<br><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * project : redis-study-jedis</span><br><span class="hljs-comment"> * description : 手机验证码生成</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> AWEI</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022-04-13【星期三】</span><br><span class="hljs-comment"> **/</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneCode</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(String[] args)</span> {<br>        <span class="hljs-comment">//模拟验证码发送</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> verifyCode(<span class="hljs-string">"18888888888"</span>);<br>        <span class="hljs-keyword">if</span> (b) {<br>            <span class="hljs-comment">//校验发送的验证码</span><br>            getRedisCode(<span class="hljs-string">"18888888888"</span>, <span class="hljs-string">"888888"</span>);<br>        }<br>    }<br><br>    <span class="hljs-comment">//生成6位数字验证码</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCode</span> <span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> RandomUtil.randomNumbers(<span class="hljs-number">6</span>);<br>    }<br><br>    <span class="hljs-comment">//计算当天剩余时间</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">remain</span> <span class="hljs-params">()</span> {<br>        <span class="hljs-type">DateTime</span> <span class="hljs-variable">endOfDay</span> <span class="hljs-operator">=</span> DateUtil.endOfDay(DateUtil.date());<br>        <span class="hljs-type">DateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> DateUtil.date();<br>        <span class="hljs-keyword">return</span> DateUtil.between(endOfDay, now, DateUnit.SECOND);<br>    }<br><br>    <span class="hljs-comment">//设置手机每天只能验证三次，并把验证码放到redis中，设置过期时间</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifyCode</span> <span class="hljs-params">(String phone)</span> {<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">//创建Jedis对象</span><br>        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"192.168.137.130"</span>, <span class="hljs-number">6379</span>);<br>        <span class="hljs-comment">//密码认证</span><br>        jedis.auth(<span class="hljs-string">"root"</span>);<br><br>        <span class="hljs-comment">//拼接key</span><br>        <span class="hljs-comment">//手机发送次数</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">countKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"VerifyCode"</span> + phone + <span class="hljs-string">":count"</span>;<br>        <span class="hljs-comment">//验证码key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">codeKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"VerifyCode"</span> + phone + <span class="hljs-string">":code"</span>;<br><br>        <span class="hljs-comment">//每个手机一天只能收到三次验证码,每日0点刷新</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> jedis.get(countKey);<br>        <span class="hljs-keyword">if</span> (count == <span class="hljs-literal">null</span>) {<br>            <span class="hljs-comment">//没有接收过验证码，第一次发送，设置发送次数为1</span><br>            DateUtil.beginOfSecond(DateUtil.date());<br>            jedis.setex(countKey, remain(), <span class="hljs-string">"1"</span>);<br>            <span class="hljs-comment">//发送的验证码要放到redis中,设置过期时间为120s</span><br>            jedis.setex(codeKey, <span class="hljs-number">120</span>, getCode());<br>            flag = <span class="hljs-literal">true</span>;<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Integer.parseInt(count) &lt;= <span class="hljs-number">2</span>) {<br>            <span class="hljs-comment">//接收次数小于3，次数+1</span><br>            jedis.incr(countKey);<br>            <span class="hljs-comment">//发送的验证码要放到redis中,设置过期时间为120s</span><br>            jedis.setex(codeKey, <span class="hljs-number">120</span>, getCode());<br>            flag = <span class="hljs-literal">true</span>;<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Integer.parseInt(count) &gt; <span class="hljs-number">2</span>) {<br>            <span class="hljs-comment">//接收三次了，不能再发送了</span><br>            System.out.println(<span class="hljs-string">"今天的发送次数已经超过3次了"</span>);<br>        }<br><br>        <span class="hljs-comment">//关闭连接</span><br>        jedis.close();<br>        <span class="hljs-keyword">return</span> flag;<br>    }<br><br>    <span class="hljs-comment">//验证码校验</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getRedisCode</span> <span class="hljs-params">(String phone, String code)</span> {<br>        <span class="hljs-comment">//创建Jedis对象</span><br>        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"192.168.137.130"</span>, <span class="hljs-number">6379</span>);<br>        <span class="hljs-comment">//密码认证</span><br>        jedis.auth(<span class="hljs-string">"root"</span>);<br><br>        <span class="hljs-comment">//验证码key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">codeKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"VerifyCode"</span> + phone + <span class="hljs-string">":code"</span>;<br>        <span class="hljs-comment">//从redis中获取验证码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">redisCode</span> <span class="hljs-operator">=</span> jedis.get(codeKey);<br><br>        <span class="hljs-comment">//判断</span><br>        <span class="hljs-keyword">if</span> (redisCode.equals(code)) {<br>            System.out.println(<span class="hljs-string">"成功"</span>);<br>        } <span class="hljs-keyword">else</span> {<br>            System.out.println(<span class="hljs-string">"失败"</span>);<br>        }<br><br>        <span class="hljs-comment">//关闭连接</span><br>        jedis.close();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>测试结果</p><ul><li><p>验证码错误</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413113401.png" srcset="/img/loading.gif" lazyload alt="image-20220413113401758"></p></li><li><p>超过每日次数限制</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413115218.png" srcset="/img/loading.gif" lazyload alt="image-20220413115218271"></p></li><li><p>redis 数据</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413113500.png" srcset="/img/loading.gif" lazyload alt="image-20220413113500447"></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220413113636.png" srcset="/img/loading.gif" lazyload alt="image-20220413113636287"></p></li></ul></li></ul><h1 id="SpringBoot-整合"><a href="#SpringBoot-整合" class="headerlink" title="SpringBoot 整合"></a>SpringBoot 整合</h1><ol><li><p>导入依赖</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--redis--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--hutools工具箱--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.0.M2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--Redis工具类--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>wiki.xsx<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>编写 application.yaml 中 redis 配置</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml">server:<br>  port: 8080<br><br>spring:<br>  redis:<br>    #Redis服务器地址<br>    host: 192.168.137.130<br>    #Redis密码<br>    password: root<br>    #Redis数据库索引（默认为0）<br>    database: 0<br>    #Redis服务器连接端口<br>    port: 6379<br>    #连接超时时间（毫秒）<br>    timeout: 1800000<br>    lettuce:<br>      pool:<br>        #连接池最大连接数（使用负值表示没有限制）<br>        max-active: 20<br>        #最大阻塞等待时间(负数表示没限制)<br>        max-wait: -1<br>        #连接池中的最大空闲连接<br>        max-idle: 5<br>        #连接池中的最小空闲连接<br>        min-idle: 0<br></code></pre></td></tr></tbody></table></figure></li><li><p>编写 redis 配置类</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.zlw.springboot_redis.config;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> org.springframework.cache.CacheManager;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.CachingConfigurerSupport;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.EnableCaching;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.cache.RedisCacheManager;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;<br><br><span class="hljs-keyword">import</span> java.time.Duration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * project : springboot_redis</span><br><span class="hljs-comment"> * description : Redis配置类</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> AWEI</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022-04-15【星期五】</span><br><span class="hljs-comment"> **/</span><br><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CachingConfigurerSupport</span> {<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span> <span class="hljs-params">(RedisConnectionFactory factory)</span> {<br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        RedisSerializer&lt;String&gt; redisSerializer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(om);<br>        template.setConnectionFactory(factory);<br>        <span class="hljs-comment">//key序列化方式</span><br>        template.setKeySerializer(redisSerializer);<br>        <span class="hljs-comment">//value序列化</span><br>        template.setValueSerializer(jackson2JsonRedisSerializer);<br>        <span class="hljs-comment">//value hashmap序列化</span><br>        template.setHashValueSerializer(jackson2JsonRedisSerializer);<br>        <span class="hljs-keyword">return</span> template;<br>    }<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span> <span class="hljs-params">(RedisConnectionFactory factory)</span> {<br>        RedisSerializer&lt;String&gt; redisSerializer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-comment">//解决查询缓存转换异常的问题</span><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(om);<br>        <span class="hljs-comment">// 配置序列化（解决乱码的问题）,过期时间600秒</span><br>        <span class="hljs-type">RedisCacheConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig()<br>                .entryTtl(Duration.ofSeconds(<span class="hljs-number">600</span>))<br>                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))<br>                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))<br>                .disableCachingNullValues();<br>        <span class="hljs-type">RedisCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> RedisCacheManager.builder(factory)<br>                .cacheDefaults(config)<br>                .build();<br>        <span class="hljs-keyword">return</span> cacheManager;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>测试 controller 方法</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.zlw.springboot_redis.config.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> wiki.xsx.core.handler.StringHandler;<br><span class="hljs-keyword">import</span> wiki.xsx.core.util.RedisUtil;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * project : springboot_redis</span><br><span class="hljs-comment"> * description :</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> AWEI</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022-04-15【星期五】</span><br><span class="hljs-comment"> **/</span><br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span> (<span class="hljs-string">"/redisTest"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTestController</span> {<br>    <span class="hljs-meta">@GetMapping</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testRedis</span> <span class="hljs-params">()</span> {<br>        <span class="hljs-type">StringHandler</span> <span class="hljs-variable">stringHandler</span> <span class="hljs-operator">=</span> RedisUtil.getStringHandler();<br>        <span class="hljs-comment">//设置值到redis</span><br>        stringHandler.set(<span class="hljs-string">"name"</span>, <span class="hljs-string">"lucy"</span>);<br>        <span class="hljs-comment">//返回redis获取的值</span><br>        <span class="hljs-keyword">return</span> stringHandler.get(<span class="hljs-string">"name"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>测试结果</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220415234503.png" srcset="/img/loading.gif" lazyload alt="image-20220415234503161"></p></li></ol><h1 id="事务和锁机制"><a href="#事务和锁机制" class="headerlink" title="事务和锁机制"></a>事务和锁机制</h1><h2 id="Redis-的事务定义"><a href="#Redis-的事务定义" class="headerlink" title="Redis 的事务定义"></a>Redis 的事务定义</h2><p>Redis 事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</p><p>Redis 事务的主要作用就是<strong>串联多个命令</strong>防止别的命令插队。</p><h2 id="Multi、Exec、discard"><a href="#Multi、Exec、discard" class="headerlink" title="Multi、Exec、discard"></a>Multi、Exec、discard</h2><p>从输入 Multi 命令开始，输入的命令都会依次进入命令队列中，但不会执行，直到输入 Exec 后，Redis 会将之前的命令队列中的命令依次执行。</p><p>组队的过程中可以通过 discard 来放弃组队。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220416124318.png" srcset="/img/loading.gif" lazyload alt="image-20220416124318161"></p><p><strong>测试</strong>：</p><ul><li><p>组队成功，提交成功。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220416124711.png" srcset="/img/loading.gif" lazyload alt="image-20220416124625005"></p></li><li><p>组队阶段报错，提交失败。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220416124823.png" srcset="/img/loading.gif" lazyload alt="image-20220416124823292"></p></li><li><p>组队成功，提交有成功有失败情况。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220416124937.png" srcset="/img/loading.gif" lazyload alt="image-20220416124937429"></p></li></ul><h2 id="事务的错误处理"><a href="#事务的错误处理" class="headerlink" title="事务的错误处理"></a>事务的错误处理</h2><p>组队中某个命令出现了报告错误，执行时整个的所有队列都会被取消。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220416125030.png" srcset="/img/loading.gif" lazyload alt="image-20220416125030450"></p><p>如果执行阶段某个命令报出了错误，则只有报错的命令不会被执行，而其他的命令都会执行，不会回滚。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220416125110.png" srcset="/img/loading.gif" lazyload alt="image-20220416125110925"></p><h2 id="事务冲突的问题"><a href="#事务冲突的问题" class="headerlink" title="事务冲突的问题"></a>事务冲突的问题</h2><p>假如一个场景：有很多人有你的账户并且该账户只有 10000, 同时去参加 618 抢购，同时发送了三个请求</p><p>一个请求想给金额减 <code>8000</code><br>一个请求想给金额减 <code>5000</code><br>一个请求想给金额减 <code>1000</code></p><p>这三个请求同时发出，假如都执行成功了，那么此时账户的余额就变成了 <code>10000-8000-5000-1000 = -4000</code>，此时账户余额变成负的了，显然这在实际生活中是很不合理的。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220416213405.png" srcset="/img/loading.gif" lazyload alt="image-20220416213405199"></p><p>那么我们就需要加锁！</p><h2 id="悲观锁（解决事务冲突）"><a href="#悲观锁（解决事务冲突）" class="headerlink" title="悲观锁（解决事务冲突）"></a>悲观锁（解决事务冲突）</h2><p>** 悲观锁 (Pessimistic Lock)**，顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会 block 直到它拿到锁。 <strong>传统的关系型数据库里边就用到了很多这种锁机制</strong>，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。</p><h2 id="乐观锁（解决事务冲突）"><a href="#乐观锁（解决事务冲突）" class="headerlink" title="乐观锁（解决事务冲突）"></a>乐观锁（解决事务冲突）</h2><p><strong>乐观锁 (Optimistic Lock)<strong>，顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。</strong>乐观锁适用于多读的应用类型，这样可以提高吞吐量</strong>。Redis 就是利用这种 check-and-set 机制实现事务的。</p><h2 id="乐观锁在-Redis-中的具体使用"><a href="#乐观锁在-Redis-中的具体使用" class="headerlink" title="乐观锁在 Redis 中的具体使用"></a>乐观锁在 Redis 中的具体使用</h2><p>在执行 multi 之前，先执行 <code>watch &lt;key1&gt; &lt;key2&gt;</code>, 可以监视一个 (或多个) key ，如果在事务<strong>执行之前这个 (或这些) key 被其他命令所改动，那么事务将被打断</strong>。</p><p><strong>测试</strong></p><p>终端一：设置键值，乐观锁监视一个 key，开启事务，执行事务，发现成功修改。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220416215858.png" srcset="/img/loading.gif" lazyload alt="image-20220416215858529"></p><p>终端二：监视一个 key，开启事务，执行事务，发现修改失败。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220416220013.png" srcset="/img/loading.gif" lazyload alt="image-20220416220013549"></p><p><strong>取消 WATCH 命令对所有 key 的监视</strong>：<code>unwatch</code></p><p>如果在执行 WATCH 命令之后，<code>EXEC</code> 命令或 <code>DISCARD</code> 命令先被执行了的话，那么就不需要再执行 <code>unwatch</code> 了。</p><h2 id="Redis-事务三大特性"><a href="#Redis-事务三大特性" class="headerlink" title="Redis 事务三大特性"></a>Redis 事务三大特性</h2><ol><li><strong>单独的隔离操作</strong><br>事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</li><li><strong>没有隔离级别的概念</strong><br>队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行</li><li><strong>不保证原子性</strong><br>事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚</li></ol><h2 id="事务的秒杀示例"><a href="#事务的秒杀示例" class="headerlink" title="事务的秒杀示例"></a>事务的秒杀示例</h2><p>在 redis 存入商品数，设定秒杀时间，提供用户秒杀窗口，用户秒杀成功，redis 中商品数 - 1，用户信息也存入 redis 中 (为了相同用户只能秒杀一次)。</p><ul><li><p>沿用上面的整合 springboot 项目</p></li><li><p>代码逻辑：通过表单，点击一个按钮，之后功能实现传输到实现的逻辑上。为了凸显逻辑，在表单中只有一个隐藏的商品和一个按钮框</p></li><li><p>pom.xml</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--hutools工具箱--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.0.M2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--Redis工具类--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>wiki.xsx<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--thymeleaf--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>yaml 配置文件</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-comment">#Redis服务器地址</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.137</span><span class="hljs-number">.130</span><br>    <span class="hljs-comment">#Redis密码</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>    <span class="hljs-comment">#Redis数据库索引（默认为0）</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-comment">#Redis服务器连接端口</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-comment">#连接超时时间（毫秒）</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">1800000</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-comment">#连接池最大连接数（使用负值表示没有限制）</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span><br>        <span class="hljs-comment">#最大阻塞等待时间(负数表示没限制)</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-number">10000</span><br>        <span class="hljs-comment">#连接池中的最大空闲连接</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">5</span><br>        <span class="hljs-comment">#连接池中的最小空闲连接</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>导入 jquery</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417132451.png" srcset="/img/loading.gif" lazyload alt="image-20220417132451279"></p></li><li><p>前端页面：</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span> = <span class="hljs-string">"en"</span> <span class="hljs-attr">xmlns:th</span> = <span class="hljs-string">"http://www.thymeleaf.org"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span> = <span class="hljs-string">"Content-Type"</span> <span class="hljs-attr">content</span> = <span class="hljs-string">"text/html; charset=UTF-8"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Insert title here<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>iPhone 13 Pro !!! 1元秒杀！！！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span> = <span class="hljs-string">"msform"</span> <span class="hljs-attr">th:action</span> = <span class="hljs-string">"@{/doSecKill}"</span> <span class="hljs-attr">enctype</span> = <span class="hljs-string">"application/x-www-form-urlencoded"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span> = <span class="hljs-string">"hidden"</span> <span class="hljs-attr">id</span> = <span class="hljs-string">"prodid"</span> <span class="hljs-attr">name</span> = <span class="hljs-string">"prodid"</span> <span class="hljs-attr">value</span> = <span class="hljs-string">"0101"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span> = <span class="hljs-string">"button"</span> <span class="hljs-attr">id</span> = <span class="hljs-string">"miaosha_btn"</span> <span class="hljs-attr">name</span> = <span class="hljs-string">"seckill_btn"</span> <span class="hljs-attr">value</span> = <span class="hljs-string">"秒杀点我"</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span> = <span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">th:src</span> = <span class="hljs-string">"@{/js/jquery-3.6.0.js}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span> = <span class="hljs-string">"text/javascript"</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">        $(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {</span><br><span class="language-javascript">            $(<span class="hljs-string">"#miaosha_btn"</span>).<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {</span><br><span class="language-javascript">                <span class="hljs-keyword">var</span> url = $(<span class="hljs-string">"#msform"</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">"action"</span>);</span><br><span class="language-javascript">                $.<span class="hljs-title function_">post</span>(url, $(<span class="hljs-string">"#msform"</span>).<span class="hljs-title function_">serialize</span>(), <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) {</span><br><span class="language-javascript">                    <span class="hljs-keyword">if</span> (data == <span class="hljs-string">"false"</span>) {</span><br><span class="language-javascript">                        <span class="hljs-title function_">alert</span>(<span class="hljs-string">"抢光了"</span>);</span><br><span class="language-javascript">                        $(<span class="hljs-string">"#miaosha_btn"</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">"disabled"</span>, <span class="hljs-literal">true</span>);</span><br><span class="language-javascript">                    }</span><br><span class="language-javascript">                });</span><br><span class="language-javascript">            })</span><br><span class="language-javascript">        })</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>业务接口以及实现类</p><ul><li><p>接口：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.zlw.springboot_redis.service;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * project : springboot_redis</span><br><span class="hljs-comment"> * description : 秒杀业务接口</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> AWEI</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022-04-17【星期日】</span><br><span class="hljs-comment"> **/</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecKill</span> {<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">doSecKill</span> <span class="hljs-params">(String uid, String prodId)</span>;<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>实现类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.zlw.springboot_redis.service;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> wiki.xsx.core.handler.NumberHandler;<br><span class="hljs-keyword">import</span> wiki.xsx.core.handler.SetHandler;<br><span class="hljs-keyword">import</span> wiki.xsx.core.handler.StringHandler;<br><span class="hljs-keyword">import</span> wiki.xsx.core.util.RedisUtil;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * project : springboot_redis</span><br><span class="hljs-comment"> * description :</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> AWEI</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022-04-17【星期日】</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecKill</span> {<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">doSecKill</span> <span class="hljs-params">(String uid, String prodId)</span> {<br>        <span class="hljs-type">NumberHandler</span> <span class="hljs-variable">numberHandler</span> <span class="hljs-operator">=</span> RedisUtil.getNumberHandler();<br>        <span class="hljs-type">SetHandler</span> <span class="hljs-variable">setHandler</span> <span class="hljs-operator">=</span> RedisUtil.getSetHandler();<br>        <span class="hljs-type">StringHandler</span> <span class="hljs-variable">stringHandler</span> <span class="hljs-operator">=</span> RedisUtil.getStringHandler();<br><br>        <span class="hljs-comment">//1 uid和prodid非空判断</span><br>        <span class="hljs-keyword">if</span> (uid == <span class="hljs-literal">null</span> || prodId == <span class="hljs-literal">null</span>) {<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br>        <span class="hljs-comment">//2 拼接key</span><br>        <span class="hljs-comment">// 2.1 库存key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">kcKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"sk:"</span> + prodId + <span class="hljs-string">":qt"</span>;<br>        <span class="hljs-comment">// 2.2 秒杀成功用户key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"sk:"</span> + prodId + <span class="hljs-string">":user"</span>;<br><br>        <span class="hljs-comment">//3 获取库存，如果库存null，秒杀还没有开始</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">kc</span> <span class="hljs-operator">=</span> stringHandler.get(kcKey);<br>        <span class="hljs-keyword">if</span> (kc == <span class="hljs-literal">null</span>) {<br>            System.out.println(<span class="hljs-string">"秒杀还没有开始，请等待"</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br>        <span class="hljs-comment">//4 判断用户是否重复秒杀操作</span><br>        <span class="hljs-keyword">if</span> (setHandler.contains(userKey, uid)) {<br>            System.out.println(<span class="hljs-string">"已经秒杀成功了，不能重复秒杀"</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br>        <span class="hljs-comment">//因为kc为字符串，所以先转换城integer类型的</span><br>        <span class="hljs-comment">//5 判断如果商品数量，库存数量小于1，秒杀结束</span><br>        <span class="hljs-keyword">if</span> (Integer.parseInt(kc) &lt;= <span class="hljs-number">0</span>) {<br>            System.out.println(<span class="hljs-string">"秒杀已经结束了"</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br>        <span class="hljs-comment">//6 库存-1</span><br>        numberHandler.decrementLong(kcKey);<br>        <span class="hljs-comment">//7 把秒杀成功用户添加清单里面</span><br>        setHandler.add(userKey, uid);<br><br>        System.out.println(<span class="hljs-string">"秒杀成功了.."</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li></ul></li><li><p>controller</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.zlw.springboot_redis.controller;<br><br><span class="hljs-keyword">import</span> cn.hutool.core.util.RandomUtil;<br><span class="hljs-keyword">import</span> com.zlw.springboot_redis.service.SecKillImpl;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.ui.Model;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * project : springboot_redis</span><br><span class="hljs-comment"> * description : 秒杀案例</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> AWEI</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022-04-17【星期日】</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillController</span> {<br>    <span class="hljs-meta">@Autowired</span><br>    SecKillImpl secKillImpl;<br><br>    <span class="hljs-meta">@RequestMapping</span> (<span class="hljs-string">"/doSecKill"</span>)<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">doSecKill</span> <span class="hljs-params">(String prodid, Model model)</span> {<br>        <span class="hljs-type">String</span> <span class="hljs-variable">userid</span> <span class="hljs-operator">=</span> RandomUtil.randomNumbers(<span class="hljs-number">5</span>);<br>        <span class="hljs-keyword">return</span> String.valueOf(secKillImpl.doSecKill(userid, prodid));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>测试结果</p><ul><li><p>数据库里尚无商品信息</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417133258.png" srcset="/img/loading.gif" lazyload alt="image-20220417133258134"></p></li><li><p>加入商品信息：<code>set sk:0101:qt 10</code></p></li><li><p>测试购买</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417133416.png" srcset="/img/loading.gif" lazyload alt="image-20220417133416002"></p><p>库存耗尽</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417133454.png" srcset="/img/loading.gif" lazyload alt="image-20220417133258134"></p></li><li><p>查看秒杀成功的用户 ID</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417133538.png" srcset="/img/loading.gif" lazyload alt="image-20220417133538790"></p></li></ul></li><li><p>基本业务逻辑搭建完成</p></li></ul><h2 id="高并发测试"><a href="#高并发测试" class="headerlink" title="高并发测试"></a>高并发测试</h2><p>这部分代码有个缺陷，就是没有模拟同时按下秒杀按钮的，一步一步进行点击不会出错，但是如果遇到了高并发的数据，就会出现 bug。</p><p>我们通过使用 <strong>ab 工具</strong>模拟高并发进行测试</p><ul><li><p>首先在 Linux 上安装 httpd-tools：<code>yum -y install httpd-tools</code></p></li><li><p>具体参数设计，主要有几个比较重要</p><ul><li>-n 请求次数</li><li>-c 当前请求次数的并发请求</li><li>-T 设计的类型，可以是 post，get</li><li>-p 提交的参数</li></ul></li><li><p>在 <code>/tmp</code> 目录下创建 postfile 文件：录入数据</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417142912.png" srcset="/img/loading.gif" lazyload alt="image-20220417142912290"></p></li><li><p>重置商品数量：<code>set sk:0101:qt 10</code></p></li><li><p>如何进行压力测试：<code>ab -n 1000 -c 100 -p /tmp/postfile -T application/x-www-form-urlencoded http://windows系统IP地址:8080/doSecKill</code></p><p>我的 windows 主机地址为：192.168.0.103，即我的测试命令为：<code>ab -n 1000 -c 100 -p /tmp/postfile -T application/x-www-form-urlencoded http://192.168.0.103:8080/doSecKill</code></p></li><li><p>执行完成查看数据库数据，发现存在<strong>负值</strong>，存在<strong>超卖现象</strong></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417143421.png" srcset="/img/loading.gif" lazyload alt="image-20220417143421871"></p></li></ul><h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><h3 id="增加连接池"><a href="#增加连接池" class="headerlink" title="增加连接池"></a>增加连接池</h3><p><strong>使用连接池解决连接超时问题。</strong></p><ul><li><p>引入依赖，开启连接池</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;!--使用 redis 连接池（无论 lettuce 还是 jedis 客户端，都需要）--&gt;<br>&lt;dependency&gt;<br>	&lt;groupId&gt;org.apache.commons&lt;/groupId&gt;<br>	&lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></tbody></table></figure></li><li><p>由于 lettuce 连接池的配置在上文已经配好，故不再赘述。</p></li><li><p>打断点可以查看到连接池配置</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417150449.png" srcset="/img/loading.gif" lazyload alt="image-20220417150449030"></p></li></ul><h3 id="增加乐观锁"><a href="#增加乐观锁" class="headerlink" title="增加乐观锁"></a>增加乐观锁</h3><p><strong>使用乐观锁解决超卖问题。</strong></p><ul><li><p>修改秒杀实现类，添加事务。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.zlw.springboot_redis.service;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> wiki.xsx.core.handler.NumberHandler;<br><span class="hljs-keyword">import</span> wiki.xsx.core.handler.SetHandler;<br><span class="hljs-keyword">import</span> wiki.xsx.core.handler.StringHandler;<br><span class="hljs-keyword">import</span> wiki.xsx.core.util.RedisUtil;<br><br><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * project : springboot_redis</span><br><span class="hljs-comment"> * description :</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> AWEI</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022-04-17【星期日】</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecKill</span> {<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">doSecKill</span> <span class="hljs-params">(String uid, String prodId)</span> {<br>        <span class="hljs-comment">//1 uid和prodid非空判断</span><br>        <span class="hljs-keyword">if</span> (uid == <span class="hljs-literal">null</span> || prodId == <span class="hljs-literal">null</span>) {<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br>        <span class="hljs-comment">//2 拼接key</span><br>        <span class="hljs-comment">// 2.1 库存key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">kcKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"sk:"</span> + prodId + <span class="hljs-string">":qt"</span>;<br>        <span class="hljs-comment">// 2.2 秒杀成功用户key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"sk:"</span> + prodId + <span class="hljs-string">":user"</span>;<br><br>        <span class="hljs-type">List</span> <span class="hljs-variable">execute</span> <span class="hljs-operator">=</span> RedisUtil.getTransactionHandler().execute(handler -&gt; {<br>            <span class="hljs-comment">// 开启监控</span><br>            handler.watch(<span class="hljs-string">"sk:0101:qt"</span>);<br><br>            <span class="hljs-comment">// 获取对应事务字符串助手</span><br>            <span class="hljs-type">StringHandler</span> <span class="hljs-variable">stringHandler</span> <span class="hljs-operator">=</span> handler.getStringHandler();<br>            <span class="hljs-comment">// 获取对应事务数字助手</span><br>            <span class="hljs-type">NumberHandler</span> <span class="hljs-variable">numberHandler</span> <span class="hljs-operator">=</span> handler.getNumberHandler();<br>            <span class="hljs-comment">// 获取对应事务无序集合助手</span><br>            <span class="hljs-type">SetHandler</span> <span class="hljs-variable">setHandler</span> <span class="hljs-operator">=</span> handler.getSetHandler();<br><br>            <span class="hljs-comment">//3 获取库存，如果库存null，秒杀还没有开始</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">kc</span> <span class="hljs-operator">=</span> stringHandler.get(kcKey);<br>            <span class="hljs-keyword">if</span> (kc == <span class="hljs-literal">null</span>) {<br>                System.out.println(<span class="hljs-string">"秒杀还没有开始，请等待"</span>);<br>                <span class="hljs-keyword">return</span> Collections.singletonList(<span class="hljs-literal">false</span>);<br>            }<br><br>            <span class="hljs-comment">//4 判断用户是否重复秒杀操作</span><br>            <span class="hljs-keyword">if</span> (setHandler.contains(userKey, uid)) {<br>                System.out.println(<span class="hljs-string">"已经秒杀成功了，不能重复秒杀"</span>);<br>                <span class="hljs-keyword">return</span> Collections.singletonList(<span class="hljs-literal">false</span>);<br>            }<br><br>            <span class="hljs-comment">//因为kc为字符串，所以先转换城integer类型的</span><br>            <span class="hljs-comment">//5 判断如果商品数量，库存数量小于1，秒杀结束</span><br>            <span class="hljs-keyword">if</span> (Integer.parseInt(kc) &lt;= <span class="hljs-number">0</span>) {<br>                System.out.println(<span class="hljs-string">"秒杀已经结束了"</span>);<br>                <span class="hljs-keyword">return</span> Collections.singletonList(<span class="hljs-literal">false</span>);<br>            }<br><br>            <span class="hljs-comment">// 开启事务</span><br>            handler.beginTransaction();<br>            <span class="hljs-comment">//6 库存-1</span><br>            numberHandler.decrementLong(kcKey);<br>            <span class="hljs-comment">//7 把秒杀成功用户添加清单里面</span><br>            setHandler.add(userKey, uid);<br>            System.out.println(<span class="hljs-string">"秒杀成功了.."</span>);<br>            <span class="hljs-comment">// 提交事务返回结果</span><br>            <span class="hljs-keyword">return</span> handler.commit();<br>        });<br><br>        <span class="hljs-keyword">if</span> (execute == <span class="hljs-literal">null</span> || execute.size() == <span class="hljs-number">0</span> || execute.get(<span class="hljs-number">0</span>).equals(<span class="hljs-literal">false</span>)) {<br>            System.out.println(<span class="hljs-string">"秒杀失败！！！"</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>使用 ab 工具测试：<code>ab -n 1000 -c 100 -p /tmp/postfile -T application/x-www-form-urlencoded http://192.168.0.103:8080/doSecKill</code></p></li><li><p>解决超卖问题</p><ul><li><p>剩余商品数目</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417220746.png" srcset="/img/loading.gif" lazyload alt="image-20220417220746189"></p></li><li><p>抢购成功用户 ID</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417220758.png" srcset="/img/loading.gif" lazyload alt="image-20220417220758449"></p></li></ul></li></ul><h3 id="库存遗留问题"><a href="#库存遗留问题" class="headerlink" title="库存遗留问题"></a>库存遗留问题</h3><p>增加了乐观锁之后，确实可以解决高并发问题，不会出现超卖的问题</p><p>增加并发量进行测试：<code>ab -n 2000 -c 300 -p /tmp/postfile -T application/x-www-form-urlencoded http://192.168.0.103:8080/doSecKill</code></p><p>执行结束后可以发现，商品会有一定程度的遗留：</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220417221736.png" srcset="/img/loading.gif" lazyload alt="image-20220417221736152"></p><p><strong>这是由于增加了乐观锁之后，假设一个人买了之后，版本改变了，下一个人都不能买了，所以出现了商品遗留的问题，商品都卖不出去。</strong>这就是库存遗留问题。</p><p>对于这个问题，我们只能使用 Lua 脚本的方式进行解决，<strong>watch 是 redis 服务中的乐观锁，Lua 脚本是 redis 中的悲观锁</strong>。</p><ul><li><p>增加一个接口方法</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">doSecKillByScript</span> <span class="hljs-params">(String uid, String prodId)</span>;<br></code></pre></td></tr></tbody></table></figure></li><li><p>实现类</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">doSecKillByScript</span> <span class="hljs-params">(String uid, String prodId)</span> {<br>    <span class="hljs-type">ScriptHandler</span> <span class="hljs-variable">scriptHandler</span> <span class="hljs-operator">=</span> RedisUtil.getScriptHandler();<br>    <span class="hljs-comment">//Lua 脚本</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">secKillScript</span> <span class="hljs-operator">=</span> <span class="hljs-string">"local userid=KEYS[1];\r\n"</span> +<br>            <span class="hljs-string">"local prodid=KEYS[2];\r\n"</span> +<br>            <span class="hljs-string">"local qtkey='sk:'..prodid..\":qt\";\r\n"</span> +<br>            <span class="hljs-string">"local usersKey='sk:'..prodid..\":usr\";\r\n"</span> +<br>            <span class="hljs-string">"local userExists=redis.call(\"sismember\",usersKey,userid);\r\n"</span> +<br>            <span class="hljs-string">"if tonumber(userExists)==1 then \r\n"</span> +<br>            <span class="hljs-string">"   return \"2\";\r\n"</span> +<br>            <span class="hljs-string">"end\r\n"</span> +<br>            <span class="hljs-string">"local num= redis.call(\"get\" ,qtkey);\r\n"</span> +<br>            <span class="hljs-string">"if tonumber(num)&lt;=0 then \r\n"</span> +<br>            <span class="hljs-string">"   return \"0\";\r\n"</span> +<br>            <span class="hljs-string">"else \r\n"</span> +<br>            <span class="hljs-string">"   redis.call(\"decr\",qtkey);\r\n"</span> +<br>            <span class="hljs-string">"   redis.call(\"sadd\",usersKey,userid);\r\n"</span> +<br>            <span class="hljs-string">"end\r\n"</span> +<br>            <span class="hljs-string">"return \"1\";"</span>;<br>    <br>    <span class="hljs-comment">//执行Lua脚本</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> scriptHandler.excute(secKillScript, String.class, Arrays.asList(uid, prodId));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">"0"</span>.equals(result)) {<br>        System.err.println(<span class="hljs-string">"已抢空！！"</span>);<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"1"</span>.equals(result)) {<br>        System.out.println(<span class="hljs-string">"抢购成功！！！！"</span>);<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"2"</span>.equals(result)) {<br>        System.err.println(<span class="hljs-string">"该用户已抢过！！"</span>);<br>    } <span class="hljs-keyword">else</span> {<br>        System.err.println(<span class="hljs-string">"抢购异常！！"</span>);<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>controller 层调用新的方法</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.zlw.springboot_redis.controller;<br><br><span class="hljs-keyword">import</span> cn.hutool.core.util.RandomUtil;<br><span class="hljs-keyword">import</span> com.zlw.springboot_redis.service.SecKillImpl;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.ui.Model;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * project : springboot_redis</span><br><span class="hljs-comment"> * description : 秒杀案例</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> AWEI</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2022-04-17【星期日】</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillController</span> {<br>    <span class="hljs-meta">@Autowired</span><br>    SecKillImpl secKillImpl;<br><br>    <span class="hljs-meta">@RequestMapping</span> (<span class="hljs-string">"/doSecKill"</span>)<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">doSecKill</span> <span class="hljs-params">(String prodid, Model model)</span> {<br>        <span class="hljs-type">String</span> <span class="hljs-variable">userid</span> <span class="hljs-operator">=</span> RandomUtil.randomNumbers(<span class="hljs-number">5</span>);<br>        <span class="hljs-keyword">return</span> String.valueOf(secKillImpl.doSecKillByScript(userid, prodid));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>重置商品数量：<code>set sk:0101:qt 500</code></p></li><li><p>进行测试：<code>ab -n 2000 -c 300 -p /tmp/postfile -T application/x-www-form-urlencoded http://192.168.0.103:8080/doSecKill</code></p></li><li><p>测试结果</p><ul><li><p>控制台输出</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220418104116.png" srcset="/img/loading.gif" lazyload alt="image-20220418104116518"></p></li><li><p>数据库数据</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220418104149.png" srcset="/img/loading.gif" lazyload alt="image-20220418104149641"></p></li></ul></li></ul><h1 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis 持久化</h1><h2 id="总体介绍"><a href="#总体介绍" class="headerlink" title="总体介绍"></a>总体介绍</h2><p>官网介绍：<a target="_blank" rel="noopener" href="http://www.redis.io/">http://www.redis.io</a></p><p>具体 Redis 提供了 2 个不同形式的持久化方式</p><ul><li>RDB（Redis DataBase）</li><li>AOF（Append Of File）</li></ul><h2 id="RDB-Redis-DataBase"><a href="#RDB-Redis-DataBase" class="headerlink" title="RDB(Redis DataBase)"></a>RDB(Redis DataBase)</h2><h3 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h3><p>在<strong>指定的时间间隔</strong>内将内存中的<strong>数据集快照</strong>写入磁盘， 也就是 Snapshot 快照，它恢复时是将快照文件直接读到内存里。</p><h3 id="具体的备份流程"><a href="#具体的备份流程" class="headerlink" title="具体的备份流程"></a>具体的备份流程</h3><p>Redis 会单独创建（fork）一个子进程来进行持久化，会先将数据写入到 一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。 整个过程中，主进程是不进行任何 IO 操作的，这就确保了极高的性能</p><ul><li>如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那 RDB 方式要比 AOF 方式更加的高效。</li><li>RDB 的缺点是最后一次持久化后的数据可能丢失。</li></ul><p>数据如果有变化的，会在 <code>/usr/local/bin</code> 目录下生成一个 dum.rdb 的文件</p><h3 id="Fork-进程"><a href="#Fork-进程" class="headerlink" title="Fork 进程"></a>Fork 进程</h3><p>Fork 的作用是复制一个与当前进程一样的进程。新进程的所有数据（变量、环境变量、程序计数器等） 数值都和原进程一致，但是是一个全新的进程，并作为原进程的子进程</p><ul><li>在 Linux 程序中，fork () 会产生一个和父进程完全相同的子进程，但子进程在此后多会 exec 系统调用，出于效率考虑，Linux 中引入了 “写时复制技术”</li><li>一般情况父进程和子进程会共用同一段物理内存，只有进程空间的各段的内容要发生变化时，才会将父进程的内容复制一份给子进程。</li></ul><h3 id="RDB持久化流程"><a href="#RDB持久化流程" class="headerlink" title="RDB持久化流程"></a>RDB 持久化流程</h3><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220418182127.png" srcset="/img/loading.gif" lazyload alt="image-20220418182127866"></p><h3 id="dump-rdb-文件"><a href="#dump-rdb-文件" class="headerlink" title="dump.rdb 文件"></a>dump.rdb 文件</h3><p>在 redis.conf 中配置文件名称，默认为 dump.rdb</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220418175809.png" srcset="/img/loading.gif" lazyload alt="image-20220418175809236"></p><h3 id="配置位置"><a href="#配置位置" class="headerlink" title="配置位置"></a>配置位置</h3><p>rdb 文件的保存路径，也可以修改。默认为 Redis 启动时命令行所在的目录下</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220418175820.png" srcset="/img/loading.gif" lazyload alt="image-20220418175820816"></p><h3 id="如何触发-RDB-快照：保存策略"><a href="#如何触发-RDB-快照：保存策略" class="headerlink" title="如何触发 RDB 快照：保存策略"></a>如何触发 RDB 快照：保存策略</h3><h4 id="配置文件中默认的快照配置"><a href="#配置文件中默认的快照配置" class="headerlink" title="配置文件中默认的快照配置"></a>配置文件中默认的快照配置</h4><p>取消注释</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220418180643.png" srcset="/img/loading.gif" lazyload alt="image-20220418180643091"></p><h4 id="Save"><a href="#Save" class="headerlink" title="Save"></a>Save</h4><p>格式：<code>save 秒钟 写操作次数</code></p><p>RDB 是整个内存的压缩过的 Snapshot，RDB 的数据结构，可以配置复合的快照触发条件</p><p>默认是 1 分钟内改了 1 万次，或 5 分钟内改了 100 次，或 60 分钟内改了 1 次。</p><p>一般直接禁用，不设置 save 指令，或者给 save 传入空字符串。</p><h4 id="命令-save-VS-bgsave"><a href="#命令-save-VS-bgsave" class="headerlink" title="命令 save VS bgsave"></a>命令 save VS bgsave</h4><p><code>save</code> ：save 时只管保存，其它不管，全部阻塞。手动保存。不建议。</p><p><code>bgsave</code>：Redis 会在后台异步进行快照操作， 快照同时还可以响应客户端请求。</p><p>可以通过 <code>lastsave</code> 命令获取最后一次成功执行快照的时间</p><h4 id="flushall-命令"><a href="#flushall-命令" class="headerlink" title="flushall 命令"></a>flushall 命令</h4><p>执行 flushall 命令，也会产生 dump.rdb 文件，但里面是空的，无意义。</p><h4 id="stop-writes-on-bgsave-error"><a href="#stop-writes-on-bgsave-error" class="headerlink" title="stop-writes-on-bgsave-error"></a>stop-writes-on-bgsave-error</h4><p>当 Redis 无法写入磁盘的话，直接关掉 Redis 的写操作。推荐 yes。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220418180933.png" srcset="/img/loading.gif" lazyload alt="image-20220418180932974"></p><h4 id="rdbcompression-压缩文件"><a href="#rdbcompression-压缩文件" class="headerlink" title="rdbcompression 压缩文件"></a>rdbcompression 压缩文件</h4><p>对于存储到磁盘中的快照，可以设置是否进行压缩存储。如果是的话，redis 会采用 <strong>LZF 算法</strong>进行压缩。</p><p>如果你不想消耗 CPU 来进行压缩的话，可以设置为关闭此功能。推荐 yes。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220418181013.png" srcset="/img/loading.gif" lazyload alt="image-20220418181013450"></p><h4 id="rdbchecksum-检查完整性"><a href="#rdbchecksum-检查完整性" class="headerlink" title="rdbchecksum 检查完整性"></a>rdbchecksum 检查完整性</h4><p>在存储快照后，还可以让 redis 使用 CRC64 算法来进行数据校验</p><p>但是这样做会增加大约 10% 的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能</p><p>推荐 yes。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220418181045.png" srcset="/img/loading.gif" lazyload alt="image-20220418181045415"></p><h4 id="rdb-的备份"><a href="#rdb-的备份" class="headerlink" title="rdb 的备份"></a>rdb 的备份</h4><p>先通过 config get dir 查询 rdb 文件的目录</p><p>将 *.rdb 的文件拷贝到别的地方</p><p>rdb 的恢复：</p><ul><li>关闭 Redis</li><li>先把备份的文件拷贝到工作目录下 <code>cp 旧的dump.rdb dump.rdb</code></li><li>启动 Redis, 备份数据会直接加载</li></ul><h3 id="优势与劣势"><a href="#优势与劣势" class="headerlink" title="优势与劣势"></a>优势与劣势</h3><ul><li><p>优势：</p><ul><li><p>适合大规模的数据恢复</p></li><li><p>对数据完整性和一致性要求不高更适合使用</p></li><li><p>节省磁盘空间</p></li><li><p>恢复速度快</p></li></ul></li><li><p>劣势：</p><ul><li><p>Fork 的时候，内存中的数据被克隆了一份，大致 2 倍的膨胀性需要考虑</p></li><li><p>虽然 Redis 在 fork 时使用了<strong>写时复制技术</strong> , 但是如果数据庞大时还是比较消耗性能。</p></li><li><p>在备份周期在一定间隔时间做一次备份，所以如果 Redis 意外 down 掉的话，就会丢失最后一次快照后的所有修改。</p></li></ul></li></ul><h3 id="如何停止-RDB"><a href="#如何停止-RDB" class="headerlink" title="如何停止 RDB"></a>如何停止 RDB</h3><p>动态停止 RDB：<code>redis-cli config set save “”</code></p><p><strong>save 后给空值，表示禁用保存策略</strong></p><h2 id="AOF（Append-Only-File）"><a href="#AOF（Append-Only-File）" class="headerlink" title="AOF（Append Only File）"></a>AOF（Append Only File）</h2><h3 id="是什么-1"><a href="#是什么-1" class="headerlink" title="是什么"></a>是什么</h3><p><strong>以日志的形式来记录每个写操作（增量保存）</strong>，将 Redis 执行过的所有写指令记录下来 (<strong>读操作不记录</strong>)， <strong>只许追加文件但不可以改写文件</strong>，redis 启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。</p><h3 id="AOF-持久化流程"><a href="#AOF-持久化流程" class="headerlink" title="AOF 持久化流程"></a>AOF 持久化流程</h3><ol><li>客户端的请求写命令会被 append 追加到 AOF 缓冲区内；</li><li>AOF 缓冲区根据 AOF 持久化策略 [always,everysec,no] 将操作 sync 同步到磁盘的 AOF 文件中；</li><li>AOF 文件大小超过重写策略或手动重写时，会对 AOF 文件 rewrite 重写，压缩 AOF 文件容量；</li><li>Redis 服务重启时，会重新 load 加载 AOF 文件中的写操作达到数据恢复的目的；</li></ol><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220418182219.png" srcset="/img/loading.gif" lazyload alt="image-20220418182219165"></p><h3 id="AOF-默认不开启"><a href="#AOF-默认不开启" class="headerlink" title="AOF 默认不开启"></a>AOF 默认不开启</h3><p>可以在 redis.conf 中配置文件名称，默认为 <strong>appendonly.aof</strong><br>AOF 文件的保存路径，同 RDB 的路径一致。</p><h3 id="AOF-和-RDB-同时开启的情况"><a href="#AOF-和-RDB-同时开启的情况" class="headerlink" title="AOF 和 RDB 同时开启的情况"></a>AOF 和 RDB 同时开启的情况</h3><p>AOF 和 RDB 同时开启，系统默认取 AOF 的数据（数据不会存在丢失）</p><h3 id="AOF-启动-修复-恢复"><a href="#AOF-启动-修复-恢复" class="headerlink" title="AOF 启动 / 修复 / 恢复"></a>AOF 启动 / 修复 / 恢复</h3><ul><li>AOF 的备份机制和性能虽然和 RDB 不同，但是备份和恢复的操作同 RDB 一样，都是拷贝备份文件，需要恢复时再拷贝到 Redis 工作目录下，启动系统即加载。</li><li>正常恢复<ol><li>修改默认的 <code>appendonly no</code>，改为 yes</li><li>将有数据的 aof 文件复制一份保存到对应目录 (查看目录：<code>config get dir</code>)</li><li>恢复：重启 redis 然后重新加载</li></ol></li><li>异常恢复<ol><li>修改默认的 appendonly no，改为 yes</li><li>如遇到 AOF 文件损坏，通过 /usr/local/bin/redis-check-aof–fix appendonly.aof 进行恢复</li><li>备份被写坏的 AOF 文件</li><li>恢复：重启 redis，然后重新加载</li></ol></li></ul><h3 id="AOF-同步频率设置"><a href="#AOF-同步频率设置" class="headerlink" title="AOF 同步频率设置"></a>AOF 同步频率设置</h3><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220419025851.png" srcset="/img/loading.gif" lazyload alt="image-20220419025851393"></p><p><code>appendfsync always</code><br>始终同步，每次 Redis 的写入都会立刻记入日志；性能较差但数据完整性比较好</p><p><code>appendfsync everysec</code><br>每秒同步，每秒记入日志一次，如果宕机，本秒的数据可能丢失。</p><p><code>appendfsync no</code><br>redis 不主动进行同步，把同步时机交给操作系统。</p><h3 id="Rewrite-压缩"><a href="#Rewrite-压缩" class="headerlink" title="Rewrite 压缩"></a>Rewrite 压缩</h3><ol><li><p>是什么？</p><p>AOF 采用文件追加方式，文件会越来越大为避免出现此种情况，新增了重写机制，当 AOF 文件的大小超过所设定的阈值时，Redis 就会启动 AOF 文件的内容压缩，只保留可以恢复数据的最小指令集。可以使用命令 <code>bgrewriteaof</code>。</p></li><li><p>重写原理，如何实现重写</p><p>AOF 文件持续增长而过大时，会 fork 出一条新进程来将文件重写 (也是先写临时文件最后再 rename)，<strong>redis4.0 版本后的重写，是指上就是把 rdb 的快照，以二级制的形式附在新的 aof 头部，作为已有的历史数据，替换掉原来的流水账操作</strong>。</p><p><strong>no-appendfsync-on-rewrite</strong>：</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220419025816.png" srcset="/img/loading.gif" lazyload alt="image-20220419025816691"></p><p>如果 <code>no-appendfsync-on-rewrite=yes</code>, 不写入 aof 文件只写入缓存，用户请求不会阻塞，但是在这段时间如果宕机会丢失这段时间的缓存数据（降低数据安全性，提高性能）。<strong>如果这个时候 redis 挂掉，就会丢失数据。丢失多少数据呢？在 linux 的操作系统的默认设置下，最多会丢失 30s 的数据</strong>。如果 <code>no-appendfsync-on-rewrite=no</code>, 还是会把数据往磁盘里刷，但是遇到重写操作，可能会发生阻塞（数据安全，但是性能降低）。</p><p><strong>触发机制，何时重写</strong><br>Redis 会记录上次重写时的 AOF 大小，默认配置是当 AOF 文件大小是上次 rewrite 后大小的一倍且文件大于 64M 时触发重写，虽然可以节约大量磁盘空间，减少恢复时间。但是每次重写还是有一定的负担的，因此设定 Redis 要满足一定条件才会进行重写。<br><code>auto-aof-rewrite-percentage</code>：设置重写的基准值，文件达到 100% 时开始重写（文件是原来重写后文件的 2 倍时触发）<br><code>auto-aof-rewrite-min-size</code>：设置重写的基准值，最小文件 64MB。达到这个值开始重写。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220419025749.png" srcset="/img/loading.gif" lazyload alt="image-20220419025749396"></p><p>例如：文件在达到 70MB 时开始重写，重写完成降到 50MB，下次什么时候开始重写？</p><p><strong>答案是 100MB（50+50*100%）&gt;64</strong><br>系统载入时或者上次重写完毕时，Redis 会记录此时 AOF 大小，设为 base_size, 如果 Redis 的 <strong>AOF 当前大小 &gt;=base_size +base_size*100% (默认)</strong> 且<strong>当前大小 &gt;=64mb (默认)</strong> 的情况下，Redis 会对 AOF 进行重写。</p></li><li><p>重写流程</p><ol><li>bgrewriteaof 触发重写，判断是否当前有 bgsave 或 bgrewriteaof 在运行，如果有，则等待该命令结束后再继续执行。</li><li>主进程 fork 出子进程执行重写操作，保证主进程不会阻塞。</li><li>子进程遍历 redis 内存中数据到临时文件，客户端的写请求同时写入 aof_buf 缓冲区和 aof_rewrite_buf 重写缓冲区保证原 AOF 文件完整以及新 AOF 文件生成期间的新的数据修改动作不会丢失。</li><li><ul><li>子进程写完新的 AOF 文件后，向主进程发信号，父进程更新统计信息。</li><li>主进程把 aof_rewrite_buf 中的数据写入到新的 AOF 文件。</li></ul></li><li>使用新的 AOF 文件覆盖旧的 AOF 文件，完成 AOF 重写。</li></ol><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220419030204.png" srcset="/img/loading.gif" lazyload alt="image-20220419030204042"></p></li></ol><h3 id="优势与劣势-1"><a href="#优势与劣势-1" class="headerlink" title="优势与劣势"></a>优势与劣势</h3><ul><li><p>优势：</p><ul><li><p>备份机制更稳健，丢失数据概率更低。</p></li><li><p>可读的日志文本，通过操作 AOF 稳健，可以处理误操作。</p></li></ul></li><li><p>劣势：</p><ul><li><p>比起 RDB 占用更多的磁盘空间。</p></li><li><p>恢复备份速度要慢。</p></li><li><p>每次读写都同步的话，有一定的性能压力。</p></li><li><p>存在个别 Bug，造成恢复不能。</p></li></ul></li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="选择哪个持久化方式"><a href="#选择哪个持久化方式" class="headerlink" title="选择哪个持久化方式"></a>选择哪个持久化方式</h3><p>官方推荐两个都启用。<br>如果对数据不敏感，可以选单独用 RDB。<br>不建议单独用 AOF，因为可能会出现 Bug。<br>如果只是做纯内存缓存，可以都不用。</p><h3 id="官方建议"><a href="#官方建议" class="headerlink" title="官方建议"></a>官方建议</h3><ul><li><p>RDB 持久化方式能够在指定的时间间隔能对你的数据进行快照存储</p></li><li><p>AOF 持久化方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，AOF 命令以 redis 协议追加保存每次写的操作到文件末尾.</p></li><li><p>Redis 还能对 AOF 文件进行后台重写，使得 AOF 文件的体积不至于过大</p></li><li><p>只做缓存：如果你只希望你的数据在服务器运行的时候存在，你也可以不使用任何持久化方式.</p></li><li><p><strong>同时开启两种持久化方式</strong></p></li><li><p>在这种情况下，当 redis 重启的时候会优先载入 AOF 文件来恢复原始的数据，因为在通常情况下 AOF 文件保存的数据集要比 RDB 文件保存的数据集要完整.</p></li><li><p>RDB 的数据不实时，同时使用两者时服务器重启也只会找 AOF 文件。那要不要只使用 AOF 呢？</p><p>建议不要，因为 RDB 更适合用于备份数据库 (AOF 在不断变化不好备份)， 快速重启，而且不会有 AOF 可能潜在的 bug，留着作为一个万一的手段。</p></li><li><p>性能建议：</p><p>因为 RDB 文件只用作后备用途，建议只在 Slave 上持久化 RDB 文件，而且只要 15 分钟备份一次就够了，只保留 <code>save 900 1</code> 这条规则。<br>如果使用 AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只 load 自己的 AOF 文件就可以了。<br><strong>代价</strong>：</p><p>一是带来了持续的 IO，二是 AOF rewrite 的最后将 rewrite 过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。<br>只要硬盘许可，应该尽量减少 AOF rewrite 的频率，AOF 重写的基础大小默认值 64M 太小了，可以设到 5G 以上。<br>默认超过原大小 100% 大小时重写可以改到适当的数值。</p></li></ul><h1 id="Redis-主从复制"><a href="#Redis-主从复制" class="headerlink" title="Redis 主从复制"></a>Redis 主从复制</h1><h2 id="是什么-2"><a href="#是什么-2" class="headerlink" title="是什么"></a>是什么</h2><p>主机数据更新后根据配置和策略， 自动同步到备机的 master/slaver 机制，Master 以写为主，Slave 以读为主。</p><h2 id="能干嘛"><a href="#能干嘛" class="headerlink" title="能干嘛"></a>能干嘛</h2><ul><li>读写分离，性能扩展</li><li>容灾快速恢复</li></ul><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220419083537.png" srcset="/img/loading.gif" lazyload alt="image-20220419083537477"></p><h2 id="具体操作：主从复制"><a href="#具体操作：主从复制" class="headerlink" title="具体操作：主从复制"></a>具体操作：主从复制</h2><ol><li><p>新建目录：/myredis <code>mkdis /myredis</code></p></li><li><p><strong>注释掉</strong></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220410225644.png" srcset="/img/loading.gif" lazyload alt="image-20220410225644567"></p></li><li><p>开启 daemonize yes</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420105020.png" srcset="/img/loading.gif" lazyload alt="image-20220420105020021"></p></li><li><p>关闭 Appendonly 或者更换其名字</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420105216.png" srcset="/img/loading.gif" lazyload alt="image-20220420105216824"></p></li><li><p>拷贝 redis.conf 文件到：/myredis <code>cp /etc/redis.conf /myredis/redis.conf</code></p></li><li><p>生成多个 redis.conf 文件，分别代表不同的数据库，模拟一主多从</p><ul><li><p><code>vim redis端口号.conf</code></p></li><li><p>文件内容</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">include /myredis/redis.conf<br>pidfile /var/run/redis_端口号.pid<br>port 端口号<br>dbfilename dump端口号.rdb<br><span class="hljs-comment"># 以下是本次演示时（同一服务器下的一主多从）的从库需要的配置</span><br>replicaof 主库IP 6379<br>masterauth root<br><span class="hljs-comment"># 设置从机的优先级，值越小，优先级越高，用于选举主机时使用。默认 100</span><br><span class="hljs-comment"># 主配置文件也有，在这里配置会优先使用这里的</span><br>replica-priority 数字<br></code></pre></td></tr></tbody></table></figure></li><li><p>这里我采用一主两从的设置，即：主（6379），从（6380，6381）</p></li><li><p><strong>（注意：集群时需要添加到每个 redis 环境的 conf 中！！）</strong>修改 slave 从库配置文件，指定主库以及密码</p><p><code>replicaof IP地址 端口</code></p><p><code>masterauth 主库密码</code></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420120159.png" srcset="/img/loading.gif" lazyload alt="image-20220420120159501"></p></li></ul></li><li><p>在 <code>/myredis</code> 目录下启动三个 redis：<code>redis-server redis端口号.conf</code></p></li><li><p>查看系统进程，看看三个 redis 服务是否启动：<code>ps -ef|grep redis</code></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420112803.png" srcset="/img/loading.gif" lazyload alt="image-20220420112802952"></p></li><li><p>连接 redis 客户端：<code>redis-cli -p 端口号 -a 密码</code></p></li><li><p>查看主机运行情况，打印主从复制的相关信息：<code>info replication</code>，可以看见主从数据库。</p><ul><li><p>6379</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420154411.png" srcset="/img/loading.gif" lazyload alt="image-20220420154411186"></p></li><li><p>6380</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420154448.png" srcset="/img/loading.gif" lazyload alt="image-20220420154448320"></p></li><li><p>6381</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420154507.png" srcset="/img/loading.gif" lazyload alt="image-20220420154507730"></p></li></ul></li><li><p>测试主从库</p><ul><li><p>主库存值，从库取值。</p><ul><li><p>测试主库（6379）存值情况</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420175326.png" srcset="/img/loading.gif" lazyload alt="image-20220420175326095"></p></li><li><p>测试从库取值情况</p><ul><li><p>6380</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420175433.png" srcset="/img/loading.gif" lazyload alt="image-20220420175433209"></p></li><li><p>6381</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420175549.png" srcset="/img/loading.gif" lazyload alt="image-20220420175443513"></p></li></ul></li></ul></li><li><p>测试从库只读</p><ul><li>6380<img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420175831.png" srcset="/img/loading.gif" lazyload alt="image-20220420175831751"></li><li>6381<img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420175854.png" srcset="/img/loading.gif" lazyload alt="image-20220420175854379"></li></ul></li></ul></li></ol><h2 id="常用的三种操作"><a href="#常用的三种操作" class="headerlink" title="常用的三种操作"></a>常用的三种操作</h2><h3 id="一主多仆"><a href="#一主多仆" class="headerlink" title="一主多仆"></a>一主多仆</h3><p>假设数据库中已经有了 <strong>”k1,k2,k3“</strong> 三个数据，一个 Slave 在这时挂掉，在挂掉的这段时间里，Master 写入了另外三个数据 <strong>“k4,k5,k6”</strong> ，在挂掉的 Slave 连回来之后，该 Slave 的数据应为完整的六个数据：<strong>“k1,k2,k3,k4,k5,k6”</strong>。</p><p>Master 挂掉之后，Slave 还是 Slave，并不会丢失 Master，在 Master 重新连接之后，恢复正常。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420183516.png" srcset="/img/loading.gif" lazyload alt="image-20220420182541088"></p><h3 id="薪火相传"><a href="#薪火相传" class="headerlink" title="薪火相传"></a>薪火相传</h3><p>即上一个 Slave 可以是下一个 slave 的 Master，这个中间的 Slave 同样可以接收其他 Slave 的连接和同步请求，那么该 Slave 作为了链条中下一个的 Master, 可以<strong>有效减轻 Master 的写压力</strong>，去中心化降低风险。</p><p>命令：<code>replicaof ip地址 端口号</code></p><p>中途变更转向：<strong>会清除之前的数据，重新建立拷贝最新的</strong>。<br>风险是一旦某个 Slave 宕机，后面的 Slave 都没法备份<br>主机挂了，从机还是从机，无法写数据了。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420183526.png" srcset="/img/loading.gif" lazyload alt="image-20220420183526355"></p><h3 id="反客为主"><a href="#反客为主" class="headerlink" title="反客为主"></a>反客为主</h3><p>当一个 Master 宕机后，后面的 Slave 可以立刻升为 Master，其后面的 Slave 不用做任 何修改。</p><p>用 <code>replicaof no one</code> 将从机变为主机。</p><h2 id="复制原理"><a href="#复制原理" class="headerlink" title="复制原理"></a>复制原理</h2><ul><li>Slave 启动成功连接到 M aster 后会发送一个 sync 命令</li><li>Master 接到命令启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令， 在后台进程执行完毕之后，Master 将传送整个数据文件到 Slave, 以完成一次完全同步</li><li>全量复制：而 Slave 服务在接收到数据库文件数据后，将其存盘并加载到内存中。</li><li>增量复制：Master 继续将新的所有收集到的修改命令依次传给 Slave, 完成同步</li><li>但是只要是重新连接 Master, 一次完全同步（全量复制) 将被自动执行</li></ul><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420183535.png" srcset="/img/loading.gif" lazyload alt="image-20220420183535411"></p><h2 id="哨兵模式-sentinel"><a href="#哨兵模式-sentinel" class="headerlink" title="哨兵模式 (sentinel)"></a>哨兵模式 (sentinel)</h2><h3 id="是什么-3"><a href="#是什么-3" class="headerlink" title="是什么"></a>是什么</h3><p><strong>反客为主的自动版</strong>，能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库。</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220420184303.png" srcset="/img/loading.gif" lazyload alt="image-20220420184303748"></p><h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><h4 id="调整为一主二仆模式"><a href="#调整为一主二仆模式" class="headerlink" title="调整为一主二仆模式"></a>调整为一主二仆模式</h4><p>调整为一主二仆模式，主库（6379）带着从库（6380，6381）。</p><h4 id="创建-sentinel-conf-文件"><a href="#创建-sentinel-conf-文件" class="headerlink" title="创建 sentinel.conf 文件"></a>创建 sentinel.conf 文件</h4><p>自定义的 /myredis 目录下新建 sentinel.conf 文件，名字绝不能出错。</p><h4 id="配置哨兵，填写内容"><a href="#配置哨兵，填写内容" class="headerlink" title="配置哨兵，填写内容"></a>配置哨兵，填写内容</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sentinel monitor 监控对象名称（任意） IP地址 端口号 认为主库失效的哨兵数<br>sentinel auth-pass 监控对象名称（任意） 密码<br></code></pre></td></tr></tbody></table></figure><p>例如：</p><p><code>sentinel monitor mymaster 127.0.0.1 6379 1</code></p><p><code>sentinel auth-pass mymaster root</code></p><p>其中 mymaster 为监控对象起的服务器名称， “1” 为指明当有多少个 sentinel 认为一个 master 失效时，master 才算真正失效。</p><h4 id="启动哨兵"><a href="#启动哨兵" class="headerlink" title="启动哨兵"></a>启动哨兵</h4><p>执行 <code>redis-sentinel /myredis/sentinel.conf</code></p><p>可以看到哨兵的端口以及 PID，监控的主库（6379），两个从库（6380，6381）</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220421013058.png" srcset="/img/loading.gif" lazyload alt="image-20220421013058554"></p><h4 id="当主库挂掉，从库选举中产生新的主库"><a href="#当主库挂掉，从库选举中产生新的主库" class="headerlink" title="当主库挂掉，从库选举中产生新的主库"></a>当主库挂掉，从库选举中产生新的主库</h4><p>根据优先级别：<code>replica-priority 数字</code> ，**(大概 10 秒左右可以看到哨兵窗口日志，切换了新的主库)**</p><p>原主库重启后会变为从库</p><p><strong>测试 6379 主库挂掉</strong></p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220421013913.png" srcset="/img/loading.gif" lazyload alt="image-20220421013913594"></p><p>可以看到哨兵<strong>检测到 6379 主库挂掉</strong>之后，<strong>投票 6380 从库作为新的主库</strong>，并把挂掉的 6379 主库<strong>作为自己的从库</strong>。</p><p>并在后台自动修改了 sentinel.conf，使 6380 成为哨兵监控的主库</p><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220421014143.png" srcset="/img/loading.gif" lazyload alt="image-20220421014143403"></p><h4 id="复制延时"><a href="#复制延时" class="headerlink" title="复制延时"></a>复制延时</h4><p>由于所有的写操作都是先在 Master 上操作，然后同步更新到 Slave 上，所以从 Master 同步到 Slave 机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave 机器数量的增加也会使这个问题更加严重。</p><h3 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h3><p><img src="https://inencoding.oss-cn-shenzhen.aliyuncs.com/img/20220421014458.png" srcset="/img/loading.gif" lazyload alt="image-20220421014458184"></p><ul><li>优先级：在 redis.conf 中默认：<code>replica-priority 100</code>，值越小优先级越高</li><li>偏移量：是指获得原主机数据<strong>最全</strong>的</li><li>runid：每个 redis 实例启动后都会随机生成一个 40 位的 runid</li></ul><h3 id="Java代码实现哨兵模式"><a href="#Java代码实现哨兵模式" class="headerlink" title="Java代码实现哨兵模式"></a>Java 代码实现哨兵模式</h3><p>使用 redisson 实现哨兵模式，可参考<a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95">官方文档</a>。</p><p><strong>依赖</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.15.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><p><strong>配置</strong></p><p>application.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">redisson:</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">classpath:redisson.yaml</span><br></code></pre></td></tr></tbody></table></figure><p>redisson.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 示例配置</span><br><span class="hljs-attr">sentinelServersConfig:</span><br>  <span class="hljs-attr">idleConnectionTimeout:</span> <span class="hljs-number">10000</span><br>  <span class="hljs-attr">pingTimeout:</span> <span class="hljs-number">1000</span><br>  <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">10000</span><br>  <span class="hljs-attr">timeout:</span> <span class="hljs-number">3000</span><br>  <span class="hljs-attr">retryAttempts:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">retryInterval:</span> <span class="hljs-number">1500</span><br>  <span class="hljs-attr">reconnectionTimeout:</span> <span class="hljs-number">3000</span><br>  <span class="hljs-attr">failedAttempts:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">password:</span> <span class="hljs-string">密码</span><br>  <span class="hljs-attr">subscriptionsPerConnection:</span> <span class="hljs-number">5</span><br>  <span class="hljs-attr">clientName:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">loadBalancer:</span> <span class="hljs-type">!&lt;org.redisson.connection.balancer.RoundRobinLoadBalancer&gt;</span> {}<br>  <span class="hljs-attr">slaveSubscriptionConnectionMinimumIdleSize:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">slaveSubscriptionConnectionPoolSize:</span> <span class="hljs-number">50</span><br>  <span class="hljs-attr">slaveConnectionMinimumIdleSize:</span> <span class="hljs-number">32</span><br>  <span class="hljs-attr">slaveConnectionPoolSize:</span> <span class="hljs-number">64</span><br>  <span class="hljs-attr">masterConnectionMinimumIdleSize:</span> <span class="hljs-number">32</span><br>  <span class="hljs-attr">masterConnectionPoolSize:</span> <span class="hljs-number">64</span><br>  <span class="hljs-attr">readMode:</span> <span class="hljs-string">"SLAVE"</span><br>  <span class="hljs-attr">sentinelAddresses:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">"IP:端口"</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">"redis://IP:端口"</span><br>  <span class="hljs-attr">masterName:</span> <span class="hljs-string">"mymaster"</span><br>  <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">threads:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">nettyThreads:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">codec:</span> <span class="hljs-type">!&lt;org.redisson.codec.JsonJacksonCodec&gt;</span> {}<br><span class="hljs-string">"transportMode"</span><span class="hljs-string">:"NIO"</span><br></code></pre></td></tr></tbody></table></figure><h1 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis 集群</h1><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>容量不够，redis 如何进行扩容？</p><p>并发写操作， redis 如何分摊？</p><p><strong>另外，主从模式、薪火相传模式，主机宕机，导致 ip 地址发生变化，应用程序中配置需要修改对应的主机地址、端口等信息</strong>。</p><p>之前通过代理主机来解决，但是 <strong>redis3.0</strong> 中提供了解决方案。就是 <strong>无中心化集群</strong>配置。</p><h2 id="什么是集群"><a href="#什么是集群" class="headerlink" title="什么是集群"></a>什么是集群</h2><p>Redis 集群实现了对 Redis 的水平扩容，即启动 N 个 redis 节点，将整个数据库分布存储在这 N 个节点中，每个节点存储总数据的 1/N。</p><p>Redis 集群通过分区（partition）来提供一定程度的可用性（availability）： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。</p><h2 id="删除持久化数据"><a href="#删除持久化数据" class="headerlink" title="删除持久化数据"></a>删除持久化数据</h2><p><strong>将 rdb,aof 文件都删除</strong></p><h2 id="制作-6-个实例"><a href="#制作-6-个实例" class="headerlink" title="制作 6 个实例"></a>制作 6 个实例</h2><h3 id="配置基本信息"><a href="#配置基本信息" class="headerlink" title="配置基本信息"></a>配置基本信息</h3><p>开启 daemonize yes<br>Pid 文件名字<br>指定端口<br>Log 文件名字<br>Dump.rdb 名字<br>Appendonly 关掉或者换名字</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="category-chain-item">学习笔记</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">#数据库</a></div></div><div class="license-box my-3"><div class="license-title"><div>Redis</div><div>https://www.inencoding.com/posts/27273/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>AWEI</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年4月4日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2022年12月8日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i></span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/posts/42142/" title="插件测试"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">插件测试</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/33152/" title="MyBatis-Plus"><span class="hidden-mobile">MyBatis-Plus</span> <span class="visible-mobile">下一篇</span><i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a><i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a><div><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量<span id="busuanzi_value_site_pv"></span> 次</span> <span id="busuanzi_container_site_uv" style="display:none">总访客数<span id="busuanzi_value_site_uv"></span> 人</span></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">粤ICP备2021025468号</a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing;(t=t.getElementById("subtitle"))&&e&&e(t.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-t}),0<o.find(".toc-list-item").length&&o.css("visibility","visible"))}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o,n=[];for(o of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))n.push(".markdown-body > "+o.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript><script src="https://fastly.jsdelivr.net/npm/hexo-tag-common@0.1.0/js/index.js"></script><script async>window.onload=function(){var e=document.createElement("script"),t=document.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.src="/sw-register.js?v="+Date.now(),t.parentNode.insertBefore(e,t)}</script></body></html>